{% extends "base/base.html" %}
{% load static %}

{% block title %}
{% if form.instance.pk %}Kampaniyanı Redaktə Et{% else %}Yeni Kampaniya{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Header -->
            <div class="mb-4">
                <h1 class="h3 mb-1">
                    {% if form.instance.pk %}
                        <i class="fas fa-edit"></i> Kampaniyanı Redaktə Et
                    {% else %}
                        <i class="fas fa-plus-circle"></i> Yeni Qiymətləndirmə Kampaniyası
                    {% endif %}
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Ana Səhifə</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'evaluations:campaign-list' %}">Kampaniyalar</a></li>
                        <li class="breadcrumb-item active">
                            {% if form.instance.pk %}Redaktə{% else %}Yeni{% endif %}
                        </li>
                    </ol>
                </nav>
            </div>

            <!-- Form Card -->
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <form method="post" id="campaignForm">
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            {{ form.non_field_errors }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endif %}

                        <!-- Basic Information -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-info-circle text-primary"></i> Əsas Məlumatlar
                            </h5>

                            <div class="mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label">
                                    Kampaniya Adı <span class="text-danger">*</span>
                                </label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <div class="invalid-feedback d-block">{{ form.title.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Məsələn: "2024 İllik Qiymətləndirmə", "Q1 Performance Review"
                                </small>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.description.id_for_label }}" class="form-label">
                                    Təsvir <span class="text-danger">*</span>
                                </label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">{{ form.description.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Kampaniyanın məqsədi və əhatə dairəsini qısaca izah edin
                                </small>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.start_date.id_for_label }}" class="form-label">
                                        Başlama Tarixi <span class="text-danger">*</span>
                                    </label>
                                    {{ form.start_date }}
                                    {% if form.start_date.errors %}
                                        <div class="invalid-feedback d-block">{{ form.start_date.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.end_date.id_for_label }}" class="form-label">
                                        Bitmə Tarixi <span class="text-danger">*</span>
                                    </label>
                                    {{ form.end_date }}
                                    {% if form.end_date.errors %}
                                        <div class="invalid-feedback d-block">{{ form.end_date.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label">
                                    Status <span class="text-danger">*</span>
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                    <div class="invalid-feedback d-block">{{ form.status.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    <strong>Layihə:</strong> Hazırlanır |
                                    <strong>Aktiv:</strong> İcra olunur |
                                    <strong>Tamamlandı:</strong> Bitib |
                                    <strong>Arxiv:</strong> Arxivləşdirilib
                                </small>
                            </div>
                        </div>

                        <!-- Advanced Settings -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-cog text-primary"></i> Əlavə Parametrlər
                            </h5>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    {{ form.anonymous_feedback }}
                                    <label class="form-check-label" for="{{ form.anonymous_feedback.id_for_label }}">
                                        Anonim Rəy
                                    </label>
                                    {% if form.anonymous_feedback.errors %}
                                        <div class="invalid-feedback d-block">{{ form.anonymous_feedback.errors }}</div>
                                    {% endif %}
                                </div>
                                <small class="form-text text-muted d-block mt-1 ms-4">
                                    Qiymətləndirənlərin kimliyi gizli qalacaq
                                </small>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    {{ form.self_evaluation_required }}
                                    <label class="form-check-label" for="{{ form.self_evaluation_required.id_for_label }}">
                                        Özünüqiymətləndirmə Məcburi
                                    </label>
                                    {% if form.self_evaluation_required.errors %}
                                        <div class="invalid-feedback d-block">{{ form.self_evaluation_required.errors }}</div>
                                    {% endif %}
                                </div>
                                <small class="form-text text-muted d-block mt-1 ms-4">
                                    Hər işçi özünü qiymətləndirməlidir
                                </small>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    {{ form.allow_comments }}
                                    <label class="form-check-label" for="{{ form.allow_comments.id_for_label }}">
                                        Şərh Yazılmasına İcazə Ver
                                    </label>
                                    {% if form.allow_comments.errors %}
                                        <div class="invalid-feedback d-block">{{ form.allow_comments.errors }}</div>
                                    {% endif %}
                                </div>
                                <small class="form-text text-muted d-block mt-1 ms-4">
                                    Qiymətləndirənlər əlavə şərh yaza bilərlər
                                </small>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    {{ form.send_reminders }}
                                    <label class="form-check-label" for="{{ form.send_reminders.id_for_label }}">
                                        Avtomatik Xatırlatma Göndər
                                    </label>
                                    {% if form.send_reminders.errors %}
                                        <div class="invalid-feedback d-block">{{ form.send_reminders.errors }}</div>
                                    {% endif %}
                                </div>
                                <small class="form-text text-muted d-block mt-1 ms-4">
                                    Tamamlanmamış qiymətləndirmələr üçün email xatırlatmaları
                                </small>
                            </div>
                        </div>

                        <!-- Questions Selection -->
                        {% if form.questions %}
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-question-circle text-primary"></i> Suallar
                            </h5>

                            <div class="mb-3">
                                <label class="form-label">Kampaniyaya daxil ediləcək sualları seçin</label>
                                {{ form.questions }}
                                {% if form.questions.errors %}
                                    <div class="invalid-feedback d-block">{{ form.questions.errors }}</div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Çoxlu sual seçmək üçün Ctrl (Windows) və ya Cmd (Mac) düyməsini basılı saxlayın
                                </small>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                            <a href="{% url 'evaluations:campaign-list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Ləğv et
                            </a>
                            <div>
                                {% if form.instance.pk %}
                                <button type="submit" name="action" value="update" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Yadda Saxla
                                </button>
                                {% else %}
                                <button type="submit" name="action" value="draft" class="btn btn-secondary me-2">
                                    <i class="fas fa-file"></i> Layihə kimi saxla
                                </button>
                                <button type="submit" name="action" value="activate" class="btn btn-success">
                                    <i class="fas fa-rocket"></i> Aktivləşdir
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Card -->
            <div class="card mt-4 border-info">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-lightbulb"></i> Məsləhətlər
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Kampaniya adını unikal və aydın seçin</li>
                        <li>Tarixləri diqqətlə müəyyənləşdirin - başlama tarixindən əvvəl iştirakçıları məlumatlandırın</li>
                        <li>Layihə statusunda kampaniyanı test edə və düzəliş edə bilərsiniz</li>
                        <li>Aktiv kampaniyada təkcə məhdud dəyişikliklər mümkündür</li>
                        <li>Anonim rəy seçimi kampaniya aktivləşdirildikdən sonra dəyişdirilə bilməz</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Date validation
        const startDate = document.querySelector('input[name="start_date"]');
        const endDate = document.querySelector('input[name="end_date"]');

        if (startDate && endDate) {
            endDate.addEventListener('change', function() {
                if (startDate.value && endDate.value) {
                    if (new Date(endDate.value) < new Date(startDate.value)) {
                        alert('Bitmə tarixi başlama tarixindən əvvəl ola bilməz!');
                        endDate.value = '';
                    }
                }
            });
        }

        // Form submission confirmation
        const form = document.getElementById('campaignForm');
        form.addEventListener('submit', function(e) {
            const action = e.submitter.value;

            if (action === 'activate') {
                if (!confirm('Kampaniyanı aktivləşdirmək istədiyinizə əminsiniz? Bu əməliyyatdan sonra bəzi parametrləri dəyişdirə bilməyəcəksiniz.')) {
                    e.preventDefault();
                    return false;
                }
            }
        });

        // Question selection helper
        const questionsSelect = document.querySelector('select[name="questions"]');
        if (questionsSelect && questionsSelect.multiple) {
            questionsSelect.setAttribute('size', '10');
        }
    });
</script>
{% endblock %}
