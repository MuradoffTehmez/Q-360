{% extends "base/base.html" %}
{% load static %}
{% load evaluation_tags %}

{% block title %}Özünüqiymətləndirmə - {{ campaign.title }}{% endblock %}

{% block extra_css %}
<style>
    .question-card {
        transition: all 0.3s;
        border-left: 4px solid #0d6efd;
    }
    .question-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .rating-scale {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
    }
    .rating-option {
        flex: 1;
        min-width: 80px;
    }
    .rating-option input[type="radio"] {
        display: none;
    }
    .rating-option label {
        display: block;
        padding: 15px;
        text-align: center;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
    }
    .rating-option input[type="radio"]:checked + label {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
        transform: scale(1.05);
    }
    .rating-option label:hover {
        border-color: #0d6efd;
        transform: translateY(-2px);
    }
    .progress-indicator {
        position: sticky;
        top: 80px;
        z-index: 100;
    }
    .category-section {
        scroll-margin-top: 150px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Progress Indicator -->
    <div class="progress-indicator mb-4">
        <div class="card shadow-sm border-primary">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">
                        <i class="fas fa-tasks"></i> Tamamlanma İrəliləyişi
                    </h6>
                    <span class="badge bg-primary fs-6" id="progressPercentage">0%</span>
                </div>
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar"
                         id="progressBar"
                         style="width: 0%">
                    </div>
                </div>
                <small class="text-muted">
                    <span id="answeredCount">0</span> / <span id="totalCount">0</span> sual cavablandırılıb
                </small>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="mb-4">
        <h1 class="h3 mb-1">
            <i class="fas fa-user-check"></i> Özünüqiymətləndirmə
        </h1>
        <p class="text-muted mb-3">{{ campaign.title }}</p>

        <div class="alert alert-info">
            <h6 class="alert-heading">
                <i class="fas fa-info-circle"></i> Özünüqiymətləndirmə Haqqında
            </h6>
            <p class="mb-0">
                Bu özünüqiymətləndirmə sizin güclü tərəflərinizi və inkişaf sahələrinizi müəyyənləşdirməyə kömək edəcək.
                Zəhmət olmasa sualları diqqətlə oxuyun və özünüzü obyektiv qiymətləndirin.
                Cavablarınız yalnız sizin və rəhbəriniz tərəfindən görünəcək.
            </p>
        </div>
    </div>

    <form method="post" id="selfAssessmentForm" class="needs-validation" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="alert alert-danger alert-dismissible fade show">
            {{ form.non_field_errors }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <!-- Category Navigation -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h6 class="mb-3">
                    <i class="fas fa-list"></i> Kateqoriyalar
                </h6>
                <div class="d-flex flex-wrap gap-2">
                    {% for category, questions in questions_by_category.items %}
                    <a href="#category-{{ forloop.counter }}" class="btn btn-outline-primary">
                        {{ category }} ({{ questions|length }})
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Questions by Category -->
        {% for category, questions in questions_by_category.items %}
        <div class="category-section mb-4" id="category-{{ forloop.counter }}">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-folder"></i> {{ category }}
                    </h5>
                </div>
                <div class="card-body">
                    {% for question in questions %}
                    <div class="question-card card mb-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h6 class="mb-1">
                                        Sual {{ forloop.counter }}
                                        {% if question.is_required %}
                                        <span class="badge bg-danger">Məcburi</span>
                                        {% endif %}
                                    </h6>
                                    <p class="mb-0">{{ question.text }}</p>
                                </div>
                                <span class="badge bg-secondary">Çəki: {{ question.weight }}</span>
                            </div>

                            {% if question.question_type == 'scale' %}
                                <!-- Scale Rating -->
                                <div class="rating-scale mb-3">
                                    {% for i in question.max_score|range_from_one %}
                                    <div class="rating-option">
                                        <input type="radio"
                                               name="question_{{ question.id }}"
                                               value="{{ i }}"
                                               id="q{{ question.id }}_{{ i }}"
                                               {% if question.is_required %}required{% endif %}
                                               class="question-input"
                                               data-question-id="{{ question.id }}">
                                        <label for="q{{ question.id }}_{{ i }}"
                                               title="{% score_label i question.max_score %}">
                                            <div class="fs-4 mb-1">{{ i }}</div>
                                            <small>
                                                {% score_label i question.max_score %}
                                            </small>
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>

                            {% elif question.question_type == 'boolean' %}
                                <!-- Boolean (Yes/No) -->
                                <div class="rating-scale mb-3" style="max-width: 300px;">
                                    <div class="rating-option">
                                        <input type="radio"
                                               name="question_{{ question.id }}"
                                               value="5"
                                               id="q{{ question.id }}_yes"
                                               {% if question.is_required %}required{% endif %}
                                               class="question-input"
                                               data-question-id="{{ question.id }}">
                                        <label for="q{{ question.id }}_yes">
                                            <i class="fas fa-check-circle fs-3 mb-2"></i>
                                            <div>Bəli</div>
                                        </label>
                                    </div>
                                    <div class="rating-option">
                                        <input type="radio"
                                               name="question_{{ question.id }}"
                                               value="1"
                                               id="q{{ question.id }}_no"
                                               {% if question.is_required %}required{% endif %}
                                               class="question-input"
                                               data-question-id="{{ question.id }}">
                                        <label for="q{{ question.id }}_no">
                                            <i class="fas fa-times-circle fs-3 mb-2"></i>
                                            <div>Xeyr</div>
                                        </label>
                                    </div>
                                </div>

                            {% elif question.question_type == 'text' %}
                                <!-- Text Response -->
                                <div class="mb-3">
                                    <textarea name="question_{{ question.id }}_text"
                                              class="form-control question-input"
                                              rows="4"
                                              placeholder="Sizin cavabınız..."
                                              {% if question.is_required %}required{% endif %}
                                              data-question-id="{{ question.id }}"></textarea>
                                </div>
                            {% endif %}

                            <!-- Additional Comments (Optional) -->
                            {% if campaign.allow_comments %}
                            <div class="mt-3">
                                <label class="form-label text-muted">
                                    <i class="fas fa-comment"></i> Əlavə şərh (istəyə bağlı)
                                </label>
                                <textarea name="question_{{ question.id }}_comment"
                                          class="form-control"
                                          rows="2"
                                          placeholder="Bu cavabınız haqqında əlavə məlumat..."></textarea>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Reflection Section -->
        <div class="card shadow-sm border-warning mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb"></i> Ümumi Refleksiya
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">
                        <strong>Əsas güclü tərəfləriniz</strong>
                        <small class="text-muted">(istəyə bağlı)</small>
                    </label>
                    <textarea name="strengths" class="form-control" rows="3"
                              placeholder="Bu dövrdə ən yaxşı nəticə göstərdiyiniz sahələri qeyd edin..."></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">
                        <strong>İnkişaf etdirmək istədiyiniz sahələr</strong>
                        <small class="text-muted">(istəyə bağlı)</small>
                    </label>
                    <textarea name="improvements" class="form-control" rows="3"
                              placeholder="Hansı sahələrdə inkişaf etmək istəyirsiniz?"></textarea>
                </div>

                <div class="mb-0">
                    <label class="form-label">
                        <strong>Əlavə qeydlər və təkliflər</strong>
                        <small class="text-muted">(istəyə bağlı)</small>
                    </label>
                    <textarea name="additional_notes" class="form-control" rows="3"
                              placeholder="Qiymətləndirmə ilə bağlı əlavə fikirlər, təkliflər..."></textarea>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="card shadow-sm sticky-bottom bg-white border-top">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button type="button" class="btn btn-outline-secondary" id="saveDraftBtn">
                            <i class="fas fa-save"></i> Qaralama Saxla
                        </button>
                        <small class="text-muted ms-2">
                            <i class="fas fa-info-circle"></i> Avtomatik saxlama aktivdir
                        </small>
                    </div>
                    <div>
                        <a href="{% url 'evaluations:my-assignments' %}" class="btn btn-outline-danger me-2">
                            <i class="fas fa-times"></i> Ləğv et
                        </a>
                        <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                            <i class="fas fa-paper-plane"></i> Göndər
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('selfAssessmentForm');
        const questionInputs = document.querySelectorAll('.question-input');
        const progressBar = document.getElementById('progressBar');
        const progressPercentage = document.getElementById('progressPercentage');
        const answeredCount = document.getElementById('answeredCount');
        const totalCount = document.getElementById('totalCount');

        // Get unique question IDs
        const questionIds = new Set();
        questionInputs.forEach(input => {
            if (input.dataset.questionId) {
                questionIds.add(input.dataset.questionId);
            }
        });

        totalCount.textContent = questionIds.size;

        // Update progress
        function updateProgress() {
            const answeredQuestions = new Set();

            questionInputs.forEach(input => {
                const questionId = input.dataset.questionId;
                if (!questionId) return;

                if (input.type === 'radio' && input.checked) {
                    answeredQuestions.add(questionId);
                } else if (input.type === 'textarea' && input.value.trim()) {
                    answeredQuestions.add(questionId);
                }
            });

            const answered = answeredQuestions.size;
            const total = questionIds.size;
            const percentage = total > 0 ? Math.round((answered / total) * 100) : 0;

            progressBar.style.width = percentage + '%';
            progressPercentage.textContent = percentage + '%';
            answeredCount.textContent = answered;

            // Change color based on progress
            progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
            if (percentage === 100) {
                progressBar.classList.add('bg-success');
            } else if (percentage >= 50) {
                progressBar.classList.add('bg-info');
            } else {
                progressBar.classList.add('bg-warning');
            }
        }

        // Listen to changes
        questionInputs.forEach(input => {
            input.addEventListener('change', updateProgress);
            input.addEventListener('input', updateProgress);
        });

        // Initial progress
        updateProgress();

        // Auto-save functionality
        let autoSaveTimeout;
        questionInputs.forEach(input => {
            input.addEventListener('change', function() {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(() => {
                    saveDraft();
                }, 2000);
            });
        });

        // Save draft
        function saveDraft() {
            const formData = new FormData(form);
            formData.append('save_draft', 'true');

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            }).then(response => {
                if (response.ok) {
                    showToast('Qaralama saxlanıldı', 'success');
                }
            }).catch(error => {
                console.error('Auto-save error:', error);
            });
        }

        document.getElementById('saveDraftBtn').addEventListener('click', function() {
            saveDraft();
            showToast('Qaralama saxlanıldı. Sonra davam edə bilərsiniz.', 'success');
        });

        // Form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            if (!form.checkValidity()) {
                e.stopPropagation();
                form.classList.add('was-validated');
                showToast('Zəhmət olmasa bütün məcburi sualları cavablandırın', 'error');

                // Scroll to first invalid input
                const firstInvalid = form.querySelector(':invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }

            if (!confirm('Özünüqiymətləndirməni göndərmək istədiyinizə əminsiniz? Göndərdikdən sonra dəyişiklik edə bilməyəcəksiniz.')) {
                return;
            }

            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Göndərilir...';

            form.submit();
        });

        // Smooth scroll for category links
        document.querySelectorAll('a[href^="#category-"]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });

        // Toast notification helper
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.innerHTML = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    });
</script>
{% endblock %}
