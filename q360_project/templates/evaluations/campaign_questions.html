{% extends "base/base.html" %}
{% load static %}

{% block title %}Sual Təyini - {{ campaign.title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Header -->
            <div class="mb-4">
                <h1 class="h3 mb-1">
                    <i class="fas fa-question-circle"></i> Kampaniyaya Sual Təyini
                </h1>
                <p class="text-muted">{{ campaign.title }} kampaniyası üçün sual və kateqoriyaları seçin</p>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Ana Səhifə</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'evaluations:campaign-list' %}">Kampaniyalar</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'evaluations:campaign-detail' campaign.pk %}">{{ campaign.title }}</a></li>
                        <li class="breadcrumb-item active">Sual Təyini</li>
                    </ol>
                </nav>
            </div>

            <!-- Info Alert -->
            <div class="alert alert-info mb-4">
                <h5 class="alert-heading">
                    <i class="fas fa-info-circle"></i> Təlimat
                </h5>
                <p class="mb-0">
                    Kampaniyada istifadə ediləcək sualları seçin. Suallar kateqoriyalara görə qruplaşdırılıb.
                    Kateqoriyanın hamısını seçmək üçün kateqoriya başlığındakı checkbox-u işarələyin.
                </p>
            </div>

            <!-- Form -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list"></i> Sualları Seçin
                        </h5>
                        <span class="badge bg-white text-primary" id="selectedCount">
                            0 sual seçildi
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" id="questionAssignForm">
                        {% csrf_token %}

                        <!-- Search and Filter -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" id="searchInput" class="form-control" placeholder="Sual axtarın...">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-primary w-100" id="selectAllBtn">
                                    <i class="fas fa-check-square"></i> Hamısını Seç
                                </button>
                            </div>
                        </div>

                        <!-- Questions by Category -->
                        <div id="categoriesContainer">
                            {% if categories %}
                                {% for category in categories %}
                                <div class="category-section mb-4" data-category-id="{{ category.id }}">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <div class="form-check">
                                                <input class="form-check-input category-checkbox" type="checkbox"
                                                       id="category_{{ category.id }}"
                                                       data-category-id="{{ category.id }}">
                                                <label class="form-check-label fw-bold" for="category_{{ category.id }}">
                                                    <i class="fas fa-folder"></i> {{ category.name }}
                                                    <span class="badge bg-secondary ms-2">{{ category.questions.count }} sual</span>
                                                </label>
                                            </div>
                                            {% if category.description %}
                                            <small class="text-muted d-block mt-2 ms-4">{{ category.description }}</small>
                                            {% endif %}
                                        </div>
                                        <div class="card-body">
                                            {% if category.questions.all %}
                                                <div class="row">
                                                    {% for question in category.questions.all %}
                                                    {% if question.is_active %}
                                                    <div class="col-md-6 mb-3 question-item" data-question-text="{{ question.text|lower }}">
                                                        <div class="card h-100 {% if question.id in assigned_questions %}border-success{% endif %}">
                                                            <div class="card-body p-3">
                                                                <div class="form-check">
                                                                    <input class="form-check-input question-checkbox"
                                                                           type="checkbox"
                                                                           name="questions"
                                                                           value="{{ question.id }}"
                                                                           id="question_{{ question.id }}"
                                                                           data-category-id="{{ category.id }}"
                                                                           {% if question.id in assigned_questions %}checked{% endif %}>
                                                                    <label class="form-check-label w-100" for="question_{{ question.id }}">
                                                                        <div class="d-flex justify-content-between align-items-start">
                                                                            <span class="flex-grow-1">{{ question.text }}</span>
                                                                            {% if question.id in assigned_questions %}
                                                                            <span class="badge bg-success ms-2">
                                                                                <i class="fas fa-check"></i>
                                                                            </span>
                                                                            {% endif %}
                                                                        </div>
                                                                        <small class="text-muted d-block mt-1">
                                                                            {% if question.question_type == 'rating' %}
                                                                                <i class="fas fa-star"></i> Qiymət (1-5)
                                                                            {% elif question.question_type == 'text' %}
                                                                                <i class="fas fa-align-left"></i> Mətn cavab
                                                                            {% elif question.question_type == 'yes_no' %}
                                                                                <i class="fas fa-check-circle"></i> Bəli/Xeyr
                                                                            {% elif question.question_type == 'multiple_choice' %}
                                                                                <i class="fas fa-list"></i> Çoxseçimli
                                                                            {% endif %}
                                                                        </small>
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <p class="text-muted mb-0">Bu kateqoriyada aktiv sual yoxdur</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i> Aktiv sual kateqoriyası tapılmadı.
                                    <a href="{% url 'evaluations:category-list' %}" class="alert-link">Buradan</a> kateqoriya yarada bilərsiniz.
                                </div>
                            {% endif %}
                        </div>

                        <!-- No Results Message -->
                        <div id="noResults" class="alert alert-warning text-center" style="display: none;">
                            <i class="fas fa-search"></i> Axtarış nəticəsi tapılmadı
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                            <a href="{% url 'evaluations:campaign-detail' campaign.pk %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Ləğv et
                            </a>
                            <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                <i class="fas fa-save"></i> Sualları Yadda Saxla
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Card -->
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-lightbulb"></i> Tövsiyələr
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Kampaniya üçün müvafiq sualları seçin</li>
                        <li>Kateqoriya başlığını seçərək bütün kateqoriyanı seçə bilərsiniz</li>
                        <li>Sualların növünə diqqət edin (qiymət, mətn, bəli/xeyr)</li>
                        <li>Artıq seçilmiş suallar yaşıl rəngdə göstərilir</li>
                        <li>Yadda saxladıqdan sonra əvvəlki seçimlər silinəcək</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .question-item {
        transition: all 0.3s ease;
    }
    .question-item:hover {
        transform: translateY(-2px);
    }
    .card.border-success {
        border-width: 2px;
    }
    .form-check-input:checked {
        background-color: #198754;
        border-color: #198754;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('questionAssignForm');
        const questionCheckboxes = document.querySelectorAll('.question-checkbox');
        const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
        const selectedCountBadge = document.getElementById('selectedCount');
        const searchInput = document.getElementById('searchInput');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const submitBtn = document.getElementById('submitBtn');
        const noResults = document.getElementById('noResults');

        // Update selected count
        function updateSelectedCount() {
            const count = document.querySelectorAll('.question-checkbox:checked').length;
            selectedCountBadge.textContent = `${count} sual seçildi`;
        }

        // Category checkbox handler
        categoryCheckboxes.forEach(categoryCheckbox => {
            categoryCheckbox.addEventListener('change', function() {
                const categoryId = this.dataset.categoryId;
                const isChecked = this.checked;
                const categoryQuestions = document.querySelectorAll(`.question-checkbox[data-category-id="${categoryId}"]`);

                categoryQuestions.forEach(checkbox => {
                    checkbox.checked = isChecked;
                });

                updateSelectedCount();
            });
        });

        // Question checkbox handler
        questionCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectedCount();

                // Update category checkbox state
                const categoryId = this.dataset.categoryId;
                const categoryQuestions = document.querySelectorAll(`.question-checkbox[data-category-id="${categoryId}"]`);
                const categoryCheckbox = document.querySelector(`.category-checkbox[data-category-id="${categoryId}"]`);

                const allChecked = Array.from(categoryQuestions).every(cb => cb.checked);
                const someChecked = Array.from(categoryQuestions).some(cb => cb.checked);

                if (categoryCheckbox) {
                    categoryCheckbox.checked = allChecked;
                    categoryCheckbox.indeterminate = someChecked && !allChecked;
                }
            });
        });

        // Search functionality
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const questionItems = document.querySelectorAll('.question-item');
            const categorySection = document.querySelectorAll('.category-section');
            let visibleCount = 0;

            if (searchTerm === '') {
                questionItems.forEach(item => item.style.display = '');
                categorySection.forEach(section => section.style.display = '');
                noResults.style.display = 'none';
                return;
            }

            questionItems.forEach(item => {
                const questionText = item.dataset.questionText;
                if (questionText.includes(searchTerm)) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // Hide empty categories
            categorySection.forEach(section => {
                const visibleQuestions = section.querySelectorAll('.question-item:not([style*="display: none"])');
                if (visibleQuestions.length === 0) {
                    section.style.display = 'none';
                } else {
                    section.style.display = '';
                }
            });

            noResults.style.display = visibleCount === 0 ? 'block' : 'none';
        });

        // Select all button
        selectAllBtn.addEventListener('click', function() {
            const allChecked = Array.from(questionCheckboxes).every(cb => cb.checked);

            questionCheckboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });

            categoryCheckboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
                checkbox.indeterminate = false;
            });

            this.innerHTML = allChecked
                ? '<i class="fas fa-check-square"></i> Hamısını Seç'
                : '<i class="fas fa-square"></i> Heç birini Seçmə';

            updateSelectedCount();
        });

        // Form submission
        form.addEventListener('submit', function(e) {
            const selectedCount = document.querySelectorAll('.question-checkbox:checked').length;

            if (selectedCount === 0) {
                e.preventDefault();
                alert('Zəhmət olmasa ən azı bir sual seçin');
                return;
            }

            if (!confirm(`${selectedCount} sual kampaniyaya təyin ediləcək. Əvvəlki seçimlər silinəcək. Davam edək?`)) {
                e.preventDefault();
                return;
            }

            // Disable submit button to prevent double submission
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Yadda saxlanılır...';
        });

        // Initialize count on page load
        updateSelectedCount();

        // Update category checkbox states on page load
        categoryCheckboxes.forEach(categoryCheckbox => {
            const categoryId = categoryCheckbox.dataset.categoryId;
            const categoryQuestions = document.querySelectorAll(`.question-checkbox[data-category-id="${categoryId}"]`);
            const allChecked = Array.from(categoryQuestions).every(cb => cb.checked);
            const someChecked = Array.from(categoryQuestions).some(cb => cb.checked);

            categoryCheckbox.checked = allChecked;
            categoryCheckbox.indeterminate = someChecked && !allChecked;
        });
    });
</script>
{% endblock %}
