{% extends "base.html" %}
{% load static %}
{% load rbac_filters %}

{% block title %}Qiymətləndirmə Nəticəsi - {{ result.evaluatee.get_full_name }} - Q360{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-1">
                                <i class="fas fa-chart-line text-primary me-2"></i>
                                Qiymətləndirmə Nəticəsi
                            </h2>
                            <p class="text-muted mb-0">
                                {{ result.evaluatee.get_full_name }} - {{ result.campaign.title }}
                            </p>
                        </div>
                        <div>
                            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Geriyə
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overall Score & Comparison -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm text-center h-100">
                <div class="card-body">
                    <i class="fas fa-trophy fa-3x text-warning mb-3"></i>
                    <h6 class="text-muted">Ümumi Bal</h6>
                    <h2 class="mb-0">{{ result.overall_score|floatformat:2 }}</h2>
                    <small class="text-muted">/5.00</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm text-center h-100">
                <div class="card-body">
                    <i class="fas fa-users fa-3x text-info mb-3"></i>
                    <h6 class="text-muted">Şöbə Ortalaması</h6>
                    <h2 class="mb-0">{{ dept_avg|default:"N/A" }}</h2>
                    {% if dept_avg %}
                    <small class="text-muted">/5.00</small>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm text-center h-100">
                <div class="card-body">
                    <i class="fas fa-building fa-3x text-success mb-3"></i>
                    <h6 class="text-muted">Təşkilat Ortalaması</h6>
                    <h2 class="mb-0">{{ org_avg|default:"N/A" }}</h2>
                    {% if org_avg %}
                    <small class="text-muted">/5.00</small>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm text-center h-100">
                <div class="card-body">
                    <i class="fas fa-calendar fa-3x text-primary mb-3"></i>
                    <h6 class="text-muted">Hesablanma Tarixi</h6>
                    <p class="mb-0">{{ result.calculated_at|date:"d.m.Y" }}</p>
                    <small class="text-muted">{{ result.calculated_at|time:"H:i" }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- Radar Chart -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-area me-2"></i>
                        Kateqoriya üzrə Radar Diaqramı
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="radarChart" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Comparison Chart -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-balance-scale me-2"></i>
                        Müqayisəli Analiz
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="comparisonChart" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Relationship Averages -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users-cog me-2"></i>
                        Qiymətləndirici Növünə görə Ortalamalar
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <i class="fas fa-user fa-2x text-primary mb-2"></i>
                                <h6>Özünüqiymətləndirmə</h6>
                                <h3>{{ relationship_averages.self|floatformat:2 }}</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <i class="fas fa-user-tie fa-2x text-warning mb-2"></i>
                                <h6>Rəhbər</h6>
                                <h3>{{ relationship_averages.supervisor|floatformat:2 }}</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <i class="fas fa-user-friends fa-2x text-success mb-2"></i>
                                <h6>Həmkarlar</h6>
                                <h3>{{ relationship_averages.peer|floatformat:2 }}</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <i class="fas fa-users fa-2x text-info mb-2"></i>
                                <h6>Tabelik</h6>
                                <h3>{{ relationship_averages.subordinate|floatformat:2 }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Breakdown -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-list-alt me-2"></i>
                        Kateqoriya üzrə Ətraflı Nəticələr
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Kateqoriya</th>
                                    <th class="text-center">Özü</th>
                                    <th class="text-center">Rəhbər</th>
                                    <th class="text-center">Həmkar</th>
                                    <th class="text-center">Tabelik</th>
                                    <th class="text-center">Ortalama</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cat in chart_data.categories %}
                                <tr>
                                    <td><strong>{{ cat }}</strong></td>
                                    <td class="text-center">
                                        <span class="badge bg-primary">{{ chart_data.self|get_item:forloop.counter0|floatformat:2 }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-warning text-dark">{{ chart_data.supervisor|get_item:forloop.counter0|floatformat:2 }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-success">{{ chart_data.peer|get_item:forloop.counter0|floatformat:2 }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">{{ chart_data.subordinate|get_item:forloop.counter0|floatformat:2 }}</span>
                                    </td>
                                    <td class="text-center">
                                        <strong>{{ chart_data.average|get_item:forloop.counter0|floatformat:2 }}</strong>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">Məlumat yoxdur</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Radar Chart
const radarCtx = document.getElementById('radarChart').getContext('2d');
const radarData = {{ radar_data|safe }};

new Chart(radarCtx, {
    type: 'radar',
    data: {
        labels: radarData.categories,
        datasets: [
            {
                label: 'Özünüqiymətləndirmə',
                data: radarData.self,
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                pointBackgroundColor: 'rgb(54, 162, 235)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgb(54, 162, 235)'
            },
            {
                label: 'Rəhbər',
                data: radarData.supervisor,
                borderColor: 'rgb(255, 193, 7)',
                backgroundColor: 'rgba(255, 193, 7, 0.2)',
                pointBackgroundColor: 'rgb(255, 193, 7)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgb(255, 193, 7)'
            },
            {
                label: 'Həmkarlar',
                data: radarData.peer,
                borderColor: 'rgb(40, 167, 69)',
                backgroundColor: 'rgba(40, 167, 69, 0.2)',
                pointBackgroundColor: 'rgb(40, 167, 69)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgb(40, 167, 69)'
            },
            {
                label: 'Tabelik',
                data: radarData.subordinate,
                borderColor: 'rgb(23, 162, 184)',
                backgroundColor: 'rgba(23, 162, 184, 0.2)',
                pointBackgroundColor: 'rgb(23, 162, 184)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgb(23, 162, 184)'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            r: {
                beginAtZero: true,
                max: 5,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                position: 'top',
            },
            title: {
                display: false
            }
        }
    }
});

// Comparison Bar Chart
const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
const comparisonData = {{ comparison_data|safe }};

new Chart(comparisonCtx, {
    type: 'bar',
    data: {
        labels: comparisonData.labels,
        datasets: [{
            label: 'Bal',
            data: comparisonData.data,
            backgroundColor: [
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 193, 7, 0.8)',
                'rgba(40, 167, 69, 0.8)'
            ],
            borderColor: [
                'rgb(54, 162, 235)',
                'rgb(255, 193, 7)',
                'rgb(40, 167, 69)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true,
                max: 5,
                ticks: {
                    stepSize: 0.5
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            title: {
                display: false
            }
        }
    }
});
</script>

<style>
.badge {
    font-size: 0.9rem;
    padding: 0.4rem 0.6rem;
}

.card {
    border: none;
}

.table > :not(caption) > * > * {
    padding: 0.75rem;
}
</style>
{% endblock %}
