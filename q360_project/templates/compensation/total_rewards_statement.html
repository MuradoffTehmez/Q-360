{% extends 'base/base.html' %}
{% load i18n static %}

{% block title %}Total Rewards Hesabatı{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<style>
    @media print {
        .no-print { display: none !important; }
        .card { break-inside: avoid; page-break-inside: avoid; }
    }

    .rewards-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    .total-value {
        font-size: 3.5rem;
        font-weight: bold;
        margin: 20px 0;
    }
    .reward-category {
        border-left: 4px solid;
        margin-bottom: 20px;
    }
    .reward-category.base { border-left-color: #007bff; }
    .reward-category.bonus { border-left-color: #28a745; }
    .reward-category.equity { border-left-color: #6f42c1; }
    .reward-category.benefits { border-left-color: #fd7e14; }
    .reward-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .reward-item:last-child {
        border-bottom: none;
    }
    .value-amount {
        font-size: 1.2rem;
        font-weight: 600;
    }
    .comparison-badge {
        font-size: 0.85rem;
        padding: 4px 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header (no-print) -->
    <div class="row mb-4 no-print">
        <div class="col-md-8">
            <h2 class="mb-3">
                <i class="fas fa-gift"></i> Total Rewards Hesabatı
            </h2>
            <p class="text-muted">
                Sizin tam kompensasiya və üstünlükləriniz
            </p>
        </div>
        <div class="col-md-4 text-right">
            <button type="button" class="btn btn-outline-primary" onclick="window.print()">
                <i class="fas fa-print"></i> Çap et
            </button>
            <button type="button" class="btn btn-primary" onclick="downloadPDF()">
                <i class="fas fa-file-pdf"></i> PDF Yüklə
            </button>
        </div>
    </div>

    <!-- Rewards Header -->
    <div class="rewards-header text-center">
        <h3>{{ user.get_full_name }}</h3>
        <p class="mb-1">{{ user.position_title }}</p>
        <p class="mb-3">{{ user.department.name }}</p>

        <div class="total-value">
            {{ total_rewards.total_value|floatformat:0 }}₼
        </div>
        <p class="mb-0">Sizin İllik Total Rewards Dəyəri</p>
        <small>{{ fiscal_year }} Maliyyə İli</small>

        {% if market_comparison %}
        <div class="mt-3">
            <span class="badge badge-light comparison-badge">
                Bazar Median ilə müqayisə:
                {% if market_comparison.difference_percentage > 0 %}
                <i class="fas fa-arrow-up text-success"></i> +{{ market_comparison.difference_percentage|floatformat:1 }}%
                {% elif market_comparison.difference_percentage < 0 %}
                <i class="fas fa-arrow-down text-danger"></i> {{ market_comparison.difference_percentage|floatformat:1 }}%
                {% else %}
                <i class="fas fa-equals"></i> 0%
                {% endif %}
            </span>
        </div>
        {% endif %}
    </div>

    <!-- Breakdown Chart -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie"></i> Rewards Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="rewardsBreakdownChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> Tərkib Nisbəti
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Əsas Maaş</span>
                            <strong>{{ total_rewards.base_percentage|floatformat:1 }}%</strong>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-primary" style="width: {{ total_rewards.base_percentage }}%">
                                {{ total_rewards.base_compensation|floatformat:0 }}₼
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Bonuslar & Təşviqəslər</span>
                            <strong>{{ total_rewards.bonus_percentage|floatformat:1 }}%</strong>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" style="width: {{ total_rewards.bonus_percentage }}%">
                                {{ total_rewards.total_bonuses|floatformat:0 }}₼
                            </div>
                        </div>
                    </div>

                    {% if total_rewards.equity_value > 0 %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Equity/Səhmlər</span>
                            <strong>{{ total_rewards.equity_percentage|floatformat:1 }}%</strong>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-purple" style="width: {{ total_rewards.equity_percentage }}%; background: #6f42c1;">
                                {{ total_rewards.equity_value|floatformat:0 }}₼
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Üstünlüklər & Ehtiyatlar</span>
                            <strong>{{ total_rewards.benefits_percentage|floatformat:1 }}%</strong>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-warning" style="width: {{ total_rewards.benefits_percentage }}%">
                                {{ total_rewards.total_benefits|floatformat:0 }}₼
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Breakdown -->
    <!-- Base Compensation -->
    <div class="card reward-category base mb-3">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-money-bill-wave text-primary"></i> Əsas Kompensasiya
            </h5>
        </div>
        <div class="card-body">
            <div class="reward-item">
                <div>
                    <strong>İllik Əsas Maaş</strong>
                    <br>
                    <small class="text-muted">Aylıq: {{ total_rewards.monthly_base|floatformat:0 }}₼</small>
                </div>
                <div class="value-amount text-primary">
                    {{ total_rewards.annual_base|floatformat:0 }}₼
                </div>
            </div>

            {% if total_rewards.allowances %}
            {% for allowance in total_rewards.allowances %}
            <div class="reward-item">
                <div>
                    <strong>{{ allowance.name }}</strong>
                    <br>
                    <small class="text-muted">{{ allowance.frequency_display }}</small>
                </div>
                <div class="value-amount text-primary">
                    {{ allowance.annual_value|floatformat:0 }}₼
                </div>
            </div>
            {% endfor %}
            {% endif %}

            <div class="reward-item border-top pt-2 mt-2">
                <div><strong>ÜMUMİ ƏSAS KOMPENSASİYA</strong></div>
                <div class="value-amount text-primary">
                    <strong>{{ total_rewards.base_compensation|floatformat:0 }}₼</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Bonuses & Incentives -->
    <div class="card reward-category bonus mb-3">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-star text-success"></i> Bonuslar və Təşviqlər
            </h5>
        </div>
        <div class="card-body">
            {% if total_rewards.bonuses %}
            {% for bonus in total_rewards.bonuses %}
            <div class="reward-item">
                <div>
                    <strong>{{ bonus.name }}</strong>
                    <br>
                    <small class="text-muted">{{ bonus.date|date:"M Y" }} - {{ bonus.type_display }}</small>
                </div>
                <div class="value-amount text-success">
                    {{ bonus.amount|floatformat:0 }}₼
                </div>
            </div>
            {% endfor %}

            <div class="reward-item border-top pt-2 mt-2">
                <div><strong>ÜMUMİ BONUSLAR</strong></div>
                <div class="value-amount text-success">
                    <strong>{{ total_rewards.total_bonuses|floatformat:0 }}₼</strong>
                </div>
            </div>
            {% else %}
            <p class="text-muted mb-0">Bu il bonus ödənişi yoxdur</p>
            {% endif %}
        </div>
    </div>

    <!-- Equity -->
    {% if total_rewards.equity_grants %}
    <div class="card reward-category equity mb-3">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-chart-line" style="color: #6f42c1;"></i> Equity & Səhmlər
            </h5>
        </div>
        <div class="card-body">
            {% for grant in total_rewards.equity_grants %}
            <div class="reward-item">
                <div>
                    <strong>{{ grant.get_equity_type_display }}</strong>
                    <br>
                    <small class="text-muted">
                        Grant: {{ grant.grant_date|date:"M Y" }} |
                        Vested: {{ grant.vested_shares }}/{{ grant.total_shares }} səhm
                    </small>
                </div>
                <div class="text-right">
                    <div class="value-amount" style="color: #6f42c1;">
                        {{ grant.current_value|floatformat:0 }}₼
                    </div>
                    <small class="text-muted">
                        Vesting: {{ grant.vesting_progress_percentage|floatformat:0 }}%
                    </small>
                </div>
            </div>
            {% endfor %}

            <div class="reward-item border-top pt-2 mt-2">
                <div>
                    <strong>ÜMUMİ EQUITY DƏYƏRİ</strong>
                    <br>
                    <small class="text-muted">(Vested + Unvested)</small>
                </div>
                <div class="value-amount" style="color: #6f42c1;">
                    <strong>{{ total_rewards.equity_value|floatformat:0 }}₼</strong>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Benefits -->
    <div class="card reward-category benefits mb-3">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-heart text-warning"></i> Üstünlüklər və Ehtiyatlar
            </h5>
        </div>
        <div class="card-body">
            {% if total_rewards.benefits %}
            {% for benefit in total_rewards.benefits %}
            <div class="reward-item">
                <div>
                    <strong>{{ benefit.name }}</strong>
                    <br>
                    <small class="text-muted">{{ benefit.description }}</small>
                </div>
                <div class="value-amount text-warning">
                    {% if benefit.monetary_value %}
                    {{ benefit.monetary_value|floatformat:0 }}₼
                    {% else %}
                    <span class="badge badge-info">İllik</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

            <div class="reward-item border-top pt-2 mt-2">
                <div><strong>ÜMUMİ ÜSTÜNLÜKLƏRİN DƏYƏRİ</strong></div>
                <div class="value-amount text-warning">
                    <strong>{{ total_rewards.total_benefits|floatformat:0 }}₼</strong>
                </div>
            </div>
            {% else %}
            <p class="text-muted mb-0">Üstünlük məlumatı yoxdur</p>
            {% endif %}
        </div>
    </div>

    <!-- Summary -->
    <div class="card border-primary">
        <div class="card-body bg-light">
            <div class="row">
                <div class="col-md-8">
                    <h4 class="mb-3">Sizin Total Rewards Paketiniz</h4>
                    <p class="mb-2">
                        Bu hesabat {{ user.company.name }} tərəfindən təqdim edilən tam kompensasiya və
                        üstünlüklərinizi göstərir. Total Rewards dəyəriniz təkcə maaşınızdan daha çoxunu
                        əhatə edir və təşkilatımızın sizə olan qiymətini əks etdirir.
                    </p>
                    <p class="mb-0 text-muted">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            Bu hesabat {{ report_generated_date|date:"d M Y" }} tarixində hazırlanmışdır.
                            Equity dəyərləri cari bazar qiymətlərinə əsaslanır və dəyişə bilər.
                        </small>
                    </p>
                </div>
                <div class="col-md-4 text-center">
                    <h3 class="text-primary mb-1">{{ total_rewards.total_value|floatformat:0 }}₼</h3>
                    <p class="mb-0 text-muted">İllik Total Dəyər</p>

                    {% if market_comparison %}
                    <div class="mt-3 p-2 bg-white rounded">
                        <small class="text-muted d-block">Bazar Pozisiyası</small>
                        <strong class="text-{{ market_comparison.status_class }}">
                            {{ market_comparison.percentile|floatformat:0 }}%
                        </strong>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Footer (print only) -->
    <div class="mt-4 text-center text-muted" style="display: none;">
        <small>
            Gizlilik və Məxfilik: Bu sənəd gizlidir və {{ user.get_full_name }} üçün nəzərdə tutulmuşdur.
            <br>
            © {{ current_year }} {{ user.company.name }}. Bütün hüquqlar qorunur.
        </small>
    </div>
</div>

<script>
// Rewards Breakdown Chart
const ctx = document.getElementById('rewardsBreakdownChart').getContext('2d');
new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: [
            'Əsas Maaş',
            'Bonuslar',
            {% if total_rewards.equity_value > 0 %}'Equity',{% endif %}
            'Üstünlüklər'
        ],
        datasets: [{
            data: [
                {{ total_rewards.base_compensation }},
                {{ total_rewards.total_bonuses }},
                {% if total_rewards.equity_value > 0 %}{{ total_rewards.equity_value }},{% endif %}
                {{ total_rewards.total_benefits }}
            ],
            backgroundColor: [
                'rgba(0, 123, 255, 0.8)',
                'rgba(40, 167, 69, 0.8)',
                {% if total_rewards.equity_value > 0 %}'rgba(111, 66, 193, 0.8)',{% endif %}
                'rgba(253, 126, 20, 0.8)'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed.toLocaleString() + '₼';
                    }
                }
            }
        }
    }
});

function downloadPDF() {
    window.location.href = '{% url "compensation:total_rewards_pdf" user.id %}?year={{ fiscal_year }}';
}
</script>
{% endblock %}
