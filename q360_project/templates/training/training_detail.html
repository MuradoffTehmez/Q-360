{% extends 'base/base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Training Details" %} - Q360{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="mt-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">{% trans "Home" %}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'training:my-trainings' %}">{% trans "My Trainings" %}</a></li>
        <li class="breadcrumb-item active">{% trans "Details" %}</li>
    </ol>
</nav>
{% endblock %}

{% block page_header %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
            <i class="fas fa-graduation-cap mr-3 text-green-500"></i><span id="trainingTitle">{% trans "Training Details" %}</span>
        </h1>
        <p class="text-gray-600 dark:text-gray-400 mt-1">{% trans "Track your learning progress" %}</p>
    </div>
    <button id="updateProgressBtn" class="hidden md:flex items-center px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg transition-all shadow-md">
        <i class="fas fa-check mr-2"></i>
        {% trans "Update Progress" %}
    </button>
</div>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Training Information -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Progress Card -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-chart-line mr-2 text-green-600"></i>
                    {% trans "Progress" %}
                </h2>
            </div>
            <div class="p-6">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-gray-700 dark:text-gray-300">{% trans "Completion" %}</span>
                    <strong class="text-2xl font-bold text-green-600 dark:text-green-400"><span id="progressPercentage">0</span>%</strong>
                </div>
                <div class="relative h-8 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden mb-6">
                    <div class="absolute top-0 left-0 h-full bg-gradient-to-r from-green-500 to-emerald-500 transition-all duration-500 flex items-center justify-center text-white text-sm font-semibold"
                         id="progressBar" style="width: 0%">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">{% trans "Status" %}</p>
                        <div id="trainingStatus" class="text-lg font-semibold">-</div>
                    </div>
                    <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">{% trans "Started" %}</p>
                        <div id="startDate" class="text-lg font-semibold text-gray-900 dark:text-white">-</div>
                    </div>
                    <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">{% trans "Due Date" %}</p>
                        <div id="dueDate" class="text-lg font-semibold text-gray-900 dark:text-white">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resource Information -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                    {% trans "Training Resource Details" %}
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">{% trans "Title" %}</span>
                        <p class="mt-1 text-gray-900 dark:text-white font-semibold" id="resourceTitle">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">{% trans "Type" %}</span>
                        <p class="mt-1" id="resourceType">-</p>
                    </div>
                    <div class="col-span-1 md:col-span-2 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">{% trans "Description" %}</span>
                        <p class="mt-1 text-gray-900 dark:text-white" id="resourceDescription">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">{% trans "Provider" %}</span>
                        <p class="mt-1 text-gray-900 dark:text-white" id="resourceProvider">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">{% trans "Difficulty" %}</span>
                        <p class="mt-1 text-gray-900 dark:text-white" id="resourceDifficulty">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">{% trans "Duration" %}</span>
                        <p class="mt-1 text-gray-900 dark:text-white" id="resourceDuration">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">{% trans "Cost" %}</span>
                        <p class="mt-1 text-gray-900 dark:text-white" id="resourceCost">-</p>
                    </div>
                    <div class="col-span-1 md:col-span-2 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">{% trans "Link" %}</span>
                        <p class="mt-1" id="resourceLink">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Required Competencies -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-star mr-2 text-yellow-500"></i>
                    {% trans "Required Competencies" %}
                </h2>
            </div>
            <div class="p-6">
                <div id="competenciesList">
                    <div class="flex justify-center">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-sticky-note mr-2 text-indigo-600"></i>
                    {% trans "My Notes" %}
                </h2>
            </div>
            <div class="p-6">
                <textarea class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-transparent" id="notesField" rows="4" placeholder="{% trans 'Add your notes here...' %}"></textarea>
                <button class="mt-3 px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg transition-all" id="saveNotesBtn">
                    <i class="fas fa-save mr-2"></i> {% trans "Save Notes" %}
                </button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Statistics -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                    {% trans "Training Info" %}
                </h2>
            </div>
            <div class="p-6">
                <div class="mb-6 text-center p-6 bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-lg border border-green-200 dark:border-green-700">
                    <h3 class="text-4xl font-bold text-green-600 dark:text-green-400 mb-2" id="daysRemaining">-</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{% trans "Days Remaining" %}</p>
                </div>
                <div class="space-y-4">
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">{% trans "Assigned By" %}</p>
                        <p class="text-gray-900 dark:text-white" id="assignedBy">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">{% trans "Related Goal" %}</p>
                        <p class="text-gray-900 dark:text-white" id="relatedGoal">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">{% trans "Certificate Obtained" %}</p>
                        <p id="certificateStatus">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-bolt mr-2 text-yellow-500"></i>
                    {% trans "Actions" %}
                </h2>
            </div>
            <div class="p-6 space-y-3">
                <button class="w-full px-4 py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg transition-all" id="markCompletedBtn">
                    <i class="fas fa-check-circle mr-2"></i> {% trans "Mark as Completed" %}
                </button>
                <button class="w-full px-4 py-3 bg-white dark:bg-gray-700 border-2 border-blue-600 text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-gray-600 rounded-lg transition-all" id="requestExtensionBtn">
                    <i class="fas fa-clock mr-2"></i> {% trans "Request Extension" %}
                </button>
                <button class="w-full px-4 py-3 bg-white dark:bg-gray-700 border-2 border-red-600 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-gray-600 rounded-lg transition-all" id="cancelTrainingBtn">
                    <i class="fas fa-times mr-2"></i> {% trans "Cancel Training" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Update Progress Modal -->
<div id="updateProgressModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{% trans "Update Progress" %}</h3>
            <button onclick="closeProgressModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="updateProgressForm">
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        {% trans "Progress Percentage" %} (%)
                    </label>
                    <input type="number" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           name="progress_percentage" id="progressInput" min="0" max="100" required>
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">{% trans "Enter a value between 0 and 100" %}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{% trans "Status" %}</label>
                    <select class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-green-500 focus:border-transparent" name="status" id="statusSelect">
                        <option value="pending">{% trans "Pending" %}</option>
                        <option value="in_progress">{% trans "In Progress" %}</option>
                        <option value="completed">{% trans "Completed" %}</option>
                        <option value="cancelled">{% trans "Cancelled" %}</option>
                    </select>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex gap-3 justify-end">
                <button type="button" onclick="closeProgressModal()" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-all">
                    {% trans "Cancel" %}
                </button>
                <button type="submit" class="px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg transition-all">
                    {% trans "Update" %}
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Modal functions
function openProgressModal() {
    document.getElementById('updateProgressModal').classList.remove('hidden');
}

function closeProgressModal() {
    document.getElementById('updateProgressModal').classList.add('hidden');
}

$(document).ready(function() {
    const trainingId = window.location.pathname.split('/').filter(x => x && x !== 'training').pop();
    let trainingData = null;

    // Load training details
    function loadTrainingDetails() {
        $.ajax({
            url: '/api/training/api/user-trainings/' + trainingId + '/',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            success: function(data) {
                trainingData = data;
                renderTrainingDetails(data);
                loadResourceDetails(data.resource);
            },
            error: function(xhr) {
                console.error('Error loading training:', xhr);
                alert('{% trans "Error loading training details" %}');
            }
        });
    }

    // Render training details
    function renderTrainingDetails(data) {
        $('#trainingTitle').text(data.resource_title || '{% trans "Training" %}');

        // Progress
        const progress = data.progress_percentage || 0;
        $('#progressPercentage').text(progress);
        $('#progressBar').css('width', progress + '%').text(progress + '%');
        $('#progressInput').val(progress);

        // Status
        const statusBadges = {
            'pending': '<span class="px-3 py-1 text-xs font-medium rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300">{% trans "Pending" %}</span>',
            'in_progress': '<span class="px-3 py-1 text-xs font-medium rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300">{% trans "In Progress" %}</span>',
            'completed': '<span class="px-3 py-1 text-xs font-medium rounded-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">{% trans "Completed" %}</span>',
            'cancelled': '<span class="px-3 py-1 text-xs font-medium rounded-full bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300">{% trans "Cancelled" %}</span>'
        };
        $('#trainingStatus').html(statusBadges[data.status] || data.status);
        $('#statusSelect').val(data.status);

        // Dates
        $('#startDate').text(data.start_date ? new Date(data.start_date).toLocaleDateString() : '-');
        $('#dueDate').text(data.due_date ? new Date(data.due_date).toLocaleDateString() : '-');

        // Calculate days remaining
        if (data.due_date) {
            const dueDate = new Date(data.due_date);
            const today = new Date();
            const diffTime = dueDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            $('#daysRemaining').text(diffDays > 0 ? diffDays : 0);
        }

        // Other info
        $('#assignedBy').text(data.assigned_by_name || '{% trans "System" %}');
        $('#relatedGoal').text(data.related_goal_title || '{% trans "None" %}');

        const certBadge = data.certificate_obtained
            ? '<span class="px-3 py-1 text-xs font-medium rounded-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300"><i class="fas fa-certificate mr-1"></i> {% trans "Yes" %}</span>'
            : '<span class="px-3 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300">{% trans "No" %}</span>';
        $('#certificateStatus').html(certBadge);

        // Notes
        $('#notesField').val(data.notes || '');
    }

    // Load resource details
    function loadResourceDetails(resourceId) {
        $.ajax({
            url: '/api/training/api/resources/' + resourceId + '/',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            success: function(data) {
                $('#resourceTitle').text(data.title);

                const typeBadges = {
                    'course': '<span class="px-3 py-1 text-xs font-medium rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300">{% trans "Course" %}</span>',
                    'certification': '<span class="px-3 py-1 text-xs font-medium rounded-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">{% trans "Certification" %}</span>',
                    'mentoring': '<span class="px-3 py-1 text-xs font-medium rounded-full bg-indigo-100 dark:bg-indigo-900/30 text-indigo-800 dark:text-indigo-300">{% trans "Mentoring" %}</span>',
                    'workshop': '<span class="px-3 py-1 text-xs font-medium rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300">{% trans "Workshop" %}</span>'
                };
                $('#resourceType').html(typeBadges[data.type] || data.type);

                $('#resourceDescription').text(data.description || '{% trans "No description" %}');
                $('#resourceProvider').text(data.provider || '-');
                $('#resourceDifficulty').text(data.difficulty_level || '-');
                $('#resourceDuration').text(data.duration_hours ? data.duration_hours + ' {% trans "hours" %}' : '-');
                $('#resourceCost').text(data.cost ? data.cost + ' AZN' : '{% trans "Free" %}');

                if (data.external_link) {
                    $('#resourceLink').html('<a href="' + data.external_link + '" target="_blank">' + data.external_link + '</a>');
                } else {
                    $('#resourceLink').text('-');
                }

                // Render competencies
                if (data.required_competencies && data.required_competencies.length > 0) {
                    let html = '<div class="flex flex-wrap gap-2">';
                    data.required_competencies.forEach(comp => {
                        html += '<span class="px-3 py-1 text-xs font-medium rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-300">' + comp.name + '</span>';
                    });
                    html += '</div>';
                    $('#competenciesList').html(html);
                } else {
                    $('#competenciesList').html('<p class="text-gray-500 dark:text-gray-400">{% trans "No competencies specified" %}</p>');
                }
            },
            error: function(xhr) {
                console.error('Error loading resource:', xhr);
            }
        });
    }

    // Update progress button
    $('#updateProgressBtn').click(function() {
        openProgressModal();
    });

    // Update progress form submission
    $('#updateProgressForm').submit(function(e) {
        e.preventDefault();

        const formData = {
            progress_percentage: parseInt($('#progressInput').val()),
            status: $('#statusSelect').val()
        };

        $.ajax({
            url: '/api/training/api/user-trainings/' + trainingId + '/',
            method: 'PATCH',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(formData),
            success: function() {
                closeProgressModal();
                loadTrainingDetails();
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                successMsg.innerHTML = '<i class="fas fa-check-circle mr-2"></i>{% trans "Progress updated successfully" %}';
                document.body.appendChild(successMsg);
                setTimeout(() => successMsg.remove(), 3000);
            },
            error: function(xhr) {
                const errorMsg = document.createElement('div');
                errorMsg.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                errorMsg.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>{% trans "Error updating progress" %}';
                document.body.appendChild(errorMsg);
                setTimeout(() => errorMsg.remove(), 3000);
            }
        });
    });

    // Save notes
    $('#saveNotesBtn').click(function() {
        const notes = $('#notesField').val();

        $.ajax({
            url: '/api/training/api/user-trainings/' + trainingId + '/',
            method: 'PATCH',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({ notes: notes }),
            success: function() {
                alert('{% trans "Notes saved successfully" %}');
            },
            error: function(xhr) {
                alert('{% trans "Error saving notes" %}');
            }
        });
    });

    // Mark as completed
    $('#markCompletedBtn').click(function() {
        if (confirm('{% trans "Mark this training as completed?" %}')) {
            $.ajax({
                url: '/api/training/api/user-trainings/' + trainingId + '/',
                method: 'PATCH',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    status: 'completed',
                    progress_percentage: 100
                }),
                success: function() {
                    loadTrainingDetails();
                    alert('{% trans "Training marked as completed" %}');
                },
                error: function(xhr) {
                    alert('{% trans "Error updating training status" %}');
                }
            });
        }
    });

    // Cancel training
    $('#cancelTrainingBtn').click(function() {
        if (confirm('{% trans "Are you sure you want to cancel this training?" %}')) {
            $.ajax({
                url: '/api/training/api/user-trainings/' + trainingId + '/',
                method: 'PATCH',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({ status: 'cancelled' }),
                success: function() {
                    alert('{% trans "Training cancelled" %}');
                    window.location.href = '{% url "training:my-trainings" %}';
                },
                error: function(xhr) {
                    alert('{% trans "Error cancelling training" %}');
                }
            });
        }
    });

    // Initial load
    loadTrainingDetails();
});
</script>
{% endblock %}
