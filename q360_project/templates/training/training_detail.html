{% extends 'base/base.html' %}
{% load i18n %}
{% load static %}

{% trans "Training" as training_label %}
{% trans "No personal notes yet." as no_notes_label %}
{% trans "System" as system_label %}
{% trans "None" as none_label %}
{% trans "Not assigned" as not_assigned_label %}
{% trans "Not provided" as not_provided_label %}
{% trans "Flexible" as flexible_label %}
{% trans "Free" as free_label %}
{% trans "Obtained" as obtained_label %}
{% trans "No description provided." as no_description_label %}
{% trans "Not yet" as not_yet_label %}
{% trans "hours" as hours_label %}

{% block title %}{% trans "Training Details" %} - Q360{% endblock %}

{% block page_header %}
<div class="relative overflow-hidden rounded-3xl bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 px-6 py-8 text-white shadow-xl">
    <div class="absolute inset-0 opacity-25">
        <div class="absolute -left-8 top-4 h-48 w-48 rounded-full bg-white blur-3xl"></div>
        <div class="absolute right-0 bottom-0 h-40 w-40 rounded-full bg-pink-300 blur-3xl"></div>
    </div>
    <div class="relative z-10">
        <p class="text-xs uppercase tracking-[0.4em] text-white/70">{% trans "Training overview" %}</p>
        <h1 class="mt-2 text-3xl font-bold md:text-4xl">
            <i class="fas fa-chalkboard mr-3"></i>{% trans "Training Details" %}
        </h1>
        <p class="mt-3 text-sm text-white/80">{% trans "Review your progress, key resources, and next actions." %}</p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="space-y-8" x-data="trainingDetailPage({ id: {{ training_id }} })" x-init="init()">
    <div x-show="loading" class="grid grid-cols-1 gap-6 lg:grid-cols-3" role="status">
        <template x-for="n in 3" :key="`training-skeleton-${n}`">
            <div class="rounded-3xl border border-gray-200/70 bg-white p-6 shadow-sm dark:border-gray-700/60 dark:bg-gray-900/70">
                <div class="space-y-4 animate-pulse">
                    <div class="h-5 w-2/3 rounded-full bg-gray-200 dark:bg-gray-700"></div>
                    <div class="h-4 w-full rounded-full bg-gray-200 dark:bg-gray-700"></div>
                    <div class="h-4 w-3/4 rounded-full bg-gray-200 dark:bg-gray-700"></div>
                    <div class="h-10 w-full rounded-2xl bg-gray-200 dark:bg-gray-700"></div>
                </div>
            </div>
        </template>
    </div>

    <div x-show="!loading" x-transition.opacity style="display:none;" class="grid grid-cols-1 gap-6 lg:grid-cols-3">
        <div class="lg:col-span-2 space-y-6">
            <section class="rounded-3xl border border-gray-200/70 bg-white p-6 shadow-sm dark:border-gray-700/60 dark:bg-gray-900/80">
                <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                    <div>
                        <p class="text-xs uppercase tracking-[0.3em] text-gray-500 dark:text-gray-400">{% trans "Progress" %}</p>
                        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white" x-text="training?.resource_title || '{{ training_label|escapejs }}'"></h2>
                    </div>
                    <span class="inline-flex items-center rounded-full px-4 py-1 text-xs font-semibold" :class="statusBadgeClasses(training?.status)">
                        <i class="fas" :class="statusIcon(training?.status)"></i>
                        <span class="ml-2" x-text="statusLabel(training?.status)"></span>
                    </span>
                </header>
                <div class="mt-5 space-y-6">
                    <div>
                        <div class="flex items-center justify-between text-xs font-semibold text-gray-500 dark:text-gray-400">
                            <span>{% trans "Completion" %}</span>
                            <span x-text="(training?.progress_percentage || 0) + '%'">0%</span>
                        </div>
                        <div class="mt-2 h-3 rounded-full bg-gray-100 dark:bg-gray-800">
                            <div class="h-full rounded-full bg-gradient-to-r from-purple-500 to-pink-500" :style="`width: ${(training?.progress_percentage || 0)}%`"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-3 text-sm text-gray-600 dark:text-gray-300">
                        <div class="rounded-2xl bg-gray-50 p-4 dark:bg-gray-800/70">
                            <p class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">{% trans "Status" %}</p>
                            <p class="mt-1 font-medium text-gray-900 dark:text-white" x-text="statusLabel(training?.status)"></p>
                        </div>
                        <div class="rounded-2xl bg-gray-50 p-4 dark:bg-gray-800/70">
                            <p class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">{% trans "Start" %}</p>
                            <p class="mt-1 font-medium text-gray-900 dark:text-white" x-text="formatDate(training?.start_date)">-</p>
                        </div>
                        <div class="rounded-2xl bg-gray-50 p-4 dark:bg-gray-800/70">
                            <p class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">{% trans "Due" %}</p>
                            <p class="mt-1 font-medium text-gray-900 dark:text-white" x-text="formatDate(training?.due_date)">-</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2 text-sm text-gray-600 dark:text-gray-300">
                        <div class="rounded-2xl bg-gray-50 p-4 dark:bg-gray-800/70">
                            <p class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">{% trans "Assigned By" %}</p>
                            <p class="mt-1 font-medium text-gray-900 dark:text-white" x-text="training?.assigned_by_name || '{{ system_label|escapejs }}'"></p>
                        </div>
                        <div class="rounded-2xl bg-gray-50 p-4 dark:bg-gray-800/70">
                            <p class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">{% trans "Related Goal" %}</p>
                            <p class="mt-1 font-medium text-gray-900 dark:text-white" x-text="training?.related_goal_title || '{{ none_label|escapejs }}'"></p>
                        </div>
                    </div>
                    <div class="rounded-2xl bg-gray-50 p-4 dark:bg-gray-800/70">
                        <p class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">{% trans "Notes" %}</p>
                        <p class="mt-2 whitespace-pre-line text-sm text-gray-600 dark:text-gray-300" x-text="training?.notes || '{{ no_notes_label|escapejs }}'"></p>
                    </div>
                </div>
            </section>

            <section class="rounded-3xl border border-gray-200/70 bg-white p-6 shadow-sm dark:border-gray-700/60 dark:bg-gray-900/80" x-show="resource" style="display:none;">
                <header class="flex items-center justify-between">
                    <div>
                        <p class="text-xs uppercase tracking-[0.3em] text-gray-500 dark:text-gray-400">{% trans "Resource" %}</p>
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white" x-text="resource?.title"></h3>
                    </div>
                    <span class="inline-flex items-center rounded-full bg-indigo-50 px-3 py-1 text-xs font-semibold text-indigo-600 dark:bg-indigo-500/10 dark:text-indigo-200" x-text="formatType(resource?.type)"></span>
                </header>
                <div class="mt-5 space-y-4 text-sm text-gray-600 dark:text-gray-300">
                    <p x-text="resource?.description || '{{ no_description_label|escapejs }}'"></p>
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                        <div class="rounded-2xl bg-gray-50 p-4 dark:bg-gray-800/70">
                            <p class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">{% trans "Provider" %}</p>
                            <p class="mt-1 font-medium text-gray-900 dark:text-white" x-text="resource?.provider || '-'"></p>
                        </div>
                        <div class="rounded-2xl bg-gray-50 p-4 dark:bg-gray-800/70">
                            <p class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">{% trans "Difficulty" %}</p>
                            <p class="mt-1 font-medium text-gray-900 dark:text-white" x-text="formatDifficulty(resource?.difficulty_level)"></p>
                        </div>
                        <div class="rounded-2xl bg-gray-50 p-4 dark:bg-gray-800/70">
                            <p class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">{% trans "Duration" %}</p>
                            <p class="mt-1 font-medium text-gray-900 dark:text-white" x-text="resource?.duration_hours ? resource.duration_hours + ' {{ hours_label|escapejs }}' : '{{ flexible_label|escapejs }}'"></p>
                        </div>
                        <div class="rounded-2xl bg-gray-50 p-4 dark:bg-gray-800/70">
                            <p class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">{% trans "Cost" %}</p>
                            <p class="mt-1 font-medium text-gray-900 dark:text-white" x-text="resource?.cost ? resource.cost + ' AZN' : '{{ free_label|escapejs }}'"></p>
                        </div>
                    </div>
                    <div class="rounded-2xl bg-gray-50 p-4 dark:bg-gray-800/70">
                        <p class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">{% trans "External link" %}</p>
                        <p class="mt-1 text-sm">
                            <template x-if="resource?.external_link">
                                <a :href="resource.external_link" target="_blank" class="text-indigo-600 underline dark:text-indigo-300" x-text="resource.external_link"></a>
                            </template>
                            <template x-if="!resource?.external_link">
                                <span>{% trans "Not provided" %}</span>
                            </template>
                        </p>
                    </div>
                    <div class="rounded-2xl bg-gray-50 p-4 dark:bg-gray-800/70" x-show="resource?.required_competencies?.length" style="display:none;">
                        <p class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">{% trans "Required competencies" %}</p>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <template x-for="comp in resource.required_competencies" :key="comp.id || comp">
                                <span class="inline-flex items-center rounded-full bg-indigo-100 px-3 py-1 text-xs font-semibold text-indigo-700 dark:bg-indigo-500/10 dark:text-indigo-200" x-text="comp.name || comp"></span>
                            </template>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <aside class="space-y-6">
            <section class="rounded-3xl border border-gray-200/70 bg-white p-6 shadow-sm dark:border-gray-700/60 dark:bg-gray-900/80">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{% trans "Quick recap" %}</h3>
                <ul class="mt-5 space-y-3 text-sm text-gray-600 dark:text-gray-300">
                    <li class="flex items-center gap-3">
                        <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                        <span>{% trans "Certificate" %}: <strong x-text="training?.certificate_obtained ? '{{ obtained_label|escapejs }}' : '{{ not_yet_label|escapejs }}'"></strong></span>
                    </li>
                    <li class="flex items-center gap-3">
                        <span class="h-2 w-2 rounded-full bg-sky-500"></span>
                        <span>{% trans "Trainer" %}: <strong x-text="training?.trainer_name || '{{ not_assigned_label|escapejs }}'"></strong></span>
                    </li>
                    <li class="flex items-center gap-3">
                        <span class="h-2 w-2 rounded-full bg-purple-500"></span>
                        <span>{% trans "Last updated" %}: <strong x-text="formatDateTime(training?.updated_at)"></strong></span>
                    </li>
                </ul>
            </section>
        </aside>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function trainingDetailPage({ id }) {
    return {
        loading: true,
        training: null,
        resource: null,
        init() {
            this.fetchTraining();
        },
        statusLabel(status) {
            const labels = {
                pending: '{% trans "Pending" %}',
                in_progress: '{% trans "In Progress" %}',
                completed: '{% trans "Completed" %}',
                cancelled: '{% trans "Cancelled" %}'
            };
            return labels[status] || status || '{% trans "Unknown" %}';
        },
        statusIcon(status) {
            switch (status) {
                case 'completed':
                    return 'fa-check';
                case 'in_progress':
                    return 'fa-play';
                case 'cancelled':
                    return 'fa-ban';
                default:
                    return 'fa-hourglass-half';
            }
        },
        statusBadgeClasses(status) {
            switch (status) {
                case 'completed':
                    return 'bg-emerald-100 text-emerald-700 dark:bg-emerald-500/10 dark:text-emerald-200';
                case 'in_progress':
                    return 'bg-sky-100 text-sky-700 dark:bg-sky-500/10 dark:text-sky-200';
                case 'cancelled':
                    return 'bg-rose-100 text-rose-700 dark:bg-rose-500/10 dark:text-rose-200';
                default:
                    return 'bg-amber-100 text-amber-700 dark:bg-amber-500/10 dark:text-amber-200';
            }
        },
        formatType(type) {
            const labels = {
                course: '{% trans "Course" %}',
                certification: '{% trans "Certification" %}',
                mentoring: '{% trans "Mentoring" %}'
            };
            return labels[type] || type || '{% trans "Training" %}';
        },
        formatDifficulty(level) {
            const labels = {
                beginner: '{% trans "Beginner" %}',
                intermediate: '{% trans "Intermediate" %}',
                advanced: '{% trans "Advanced" %}'
            };
            return labels[level] || level || '{% trans "All Levels" %}';
        },
        formatDate(value) {
            if (!value) return '-';
            const date = new Date(value);
            return isNaN(date.getTime()) ? '-' : date.toLocaleDateString();
        },
        formatDateTime(value) {
            if (!value) return '-';
            const date = new Date(value);
            return isNaN(date.getTime()) ? '-' : date.toLocaleString();
        },
        authHeaders() {
            const token = window.localStorage ? localStorage.getItem('access_token') : null;
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        },
        async fetchTraining() {
            this.loading = true;
            try {
                const response = await fetch(`/api/training/api/user-trainings/${id}/`, { headers: this.authHeaders() });
                if (!response.ok) {
                    throw new Error('Unable to load training');
                }
                this.training = await response.json();
                if (this.training?.resource) {
                    await this.fetchResource(this.training.resource);
                }
            } catch (error) {
                console.error(error);
                this.training = null;
            } finally {
                this.loading = false;
            }
        },
        async fetchResource(resourceId) {
            try {
                const response = await fetch(`/api/training/api/resources/${resourceId}/`, { headers: this.authHeaders() });
                if (!response.ok) {
                    throw new Error('Unable to load resource');
                }
                this.resource = await response.json();
            } catch (error) {
                console.error(error);
                this.resource = null;
            }
        }
    };
}

document.addEventListener('alpine:init', () => {
    Alpine.data('trainingDetailPage', trainingDetailPage);
});
</script>
{% endblock %}
