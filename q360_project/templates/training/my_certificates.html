{% extends 'base/base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "My Certificates" %} - Q360{% endblock %}

{% block page_header %}
<div class="relative overflow-hidden rounded-3xl bg-gradient-to-r from-amber-500 via-orange-500 to-red-500 px-6 py-8 text-white shadow-xl">
    <div class="absolute inset-0 opacity-20">
        <div class="absolute -right-16 top-6 h-52 w-52 rounded-full bg-white blur-3xl"></div>
        <div class="absolute -left-10 bottom-0 h-40 w-40 rounded-full bg-amber-300 blur-3xl"></div>
    </div>
    <div class="relative z-10">
        <p class="text-xs uppercase tracking-[0.4em] text-white/70">{% trans "Achievement Collection" %}</p>
        <h1 class="mt-2 text-3xl font-bold md:text-4xl">
            <i class="fas fa-certificate mr-3"></i>{% trans "My Certificates" %}
        </h1>
        <p class="mt-3 text-sm text-white/80">{% trans "Manage and showcase your training certificates and accomplishments." %}</p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="space-y-8" x-data="certificatesPage()">
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 gap-6 md:grid-cols-4">
        <!-- Total Completed -->
        <div class="rounded-2xl border border-gray-200/70 bg-white p-6 shadow-sm dark:border-gray-700/60 dark:bg-gray-900/80">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">{% trans "Total Completed" %}</p>
                    <p class="mt-2 text-3xl font-bold text-gray-900 dark:text-white">{{ total_completed }}</p>
                </div>
                <div class="rounded-full bg-blue-100 p-3 dark:bg-blue-900/30">
                    <i class="fas fa-graduation-cap text-2xl text-blue-600 dark:text-blue-400"></i>
                </div>
            </div>
        </div>

        <!-- With Certificates -->
        <div class="rounded-2xl border border-gray-200/70 bg-white p-6 shadow-sm dark:border-gray-700/60 dark:bg-gray-900/80">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">{% trans "With Certificates" %}</p>
                    <p class="mt-2 text-3xl font-bold text-green-600 dark:text-green-400">{{ with_certificates }}</p>
                </div>
                <div class="rounded-full bg-green-100 p-3 dark:bg-green-900/30">
                    <i class="fas fa-certificate text-2xl text-green-600 dark:text-green-400"></i>
                </div>
            </div>
        </div>

        <!-- Without Certificates -->
        <div class="rounded-2xl border border-gray-200/70 bg-white p-6 shadow-sm dark:border-gray-700/60 dark:bg-gray-900/80">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">{% trans "Without Certificates" %}</p>
                    <p class="mt-2 text-3xl font-bold text-orange-600 dark:text-orange-400">{{ without_certificates }}</p>
                </div>
                <div class="rounded-full bg-orange-100 p-3 dark:bg-orange-900/30">
                    <i class="fas fa-exclamation-triangle text-2xl text-orange-600 dark:text-orange-400"></i>
                </div>
            </div>
        </div>

        <!-- Certificate Rate -->
        <div class="rounded-2xl border border-gray-200/70 bg-white p-6 shadow-sm dark:border-gray-700/60 dark:bg-gray-900/80">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">{% trans "Certificate Rate" %}</p>
                    <p class="mt-2 text-3xl font-bold text-purple-600 dark:text-purple-400">{{ certificate_rate }}%</p>
                </div>
                <div class="rounded-full bg-purple-100 p-3 dark:bg-purple-900/30">
                    <i class="fas fa-chart-line text-2xl text-purple-600 dark:text-purple-400"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Trainings with Certificates -->
    <div class="rounded-3xl border border-gray-200/70 bg-white p-6 shadow-sm dark:border-gray-700/60 dark:bg-gray-900/80">
        <div class="mb-6 flex items-center justify-between">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">
                <i class="fas fa-award mr-2 text-amber-500"></i>{% trans "Trainings with Certificates" %}
            </h2>
            <span class="rounded-full bg-green-100 px-3 py-1 text-sm font-semibold text-green-700 dark:bg-green-900/30 dark:text-green-300">
                {{ with_certificates }} {% trans "certificates" %}
            </span>
        </div>

        {% if trainings_with_certificates %}
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3">
            {% for training in trainings_with_certificates %}
            <div class="group relative overflow-hidden rounded-2xl border border-gray-200/70 bg-gradient-to-br from-white to-gray-50 p-5 shadow-sm transition hover:-translate-y-1 hover:shadow-lg dark:border-gray-700/60 dark:from-gray-900/80 dark:to-gray-800/80">
                <!-- Certificate Badge -->
                <div class="absolute right-4 top-4">
                    <div class="flex h-10 w-10 items-center justify-center rounded-full bg-amber-500 text-white shadow-lg">
                        <i class="fas fa-certificate"></i>
                    </div>
                </div>

                <h3 class="pr-12 text-lg font-semibold text-gray-900 dark:text-white">
                    {{ training.resource.title }}
                </h3>

                <div class="mt-3 flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                    <i class="fas fa-tag"></i>
                    <span>{{ training.resource.get_type_display }}</span>
                </div>

                <div class="mt-2 flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                    <i class="fas fa-calendar-check"></i>
                    <span>{% trans "Completed" %}: {{ training.completed_date|date:"d.m.Y" }}</span>
                </div>

                {% if training.rating %}
                <div class="mt-2 flex items-center gap-1">
                    {% for i in "12345" %}
                        {% if forloop.counter <= training.rating %}
                        <i class="fas fa-star text-amber-400"></i>
                        {% else %}
                        <i class="far fa-star text-gray-300 dark:text-gray-600"></i>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Actions -->
                <div class="mt-4 flex gap-2">
                    <a href="{{ training.certificate_url }}"
                       target="_blank"
                       class="flex-1 rounded-lg bg-gradient-to-r from-amber-500 to-orange-500 px-4 py-2 text-center text-sm font-semibold text-white shadow-sm transition hover:shadow-md">
                        <i class="fas fa-external-link-alt mr-1"></i>{% trans "View Certificate" %}
                    </a>
                    <button @click="editCertificate({{ training.id }}, '{{ training.certificate_url }}')"
                            class="rounded-lg border border-gray-300 bg-white px-3 py-2 text-gray-700 transition hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="flex flex-col items-center justify-center gap-4 py-12 text-center">
            <div class="rounded-full bg-gray-100 p-6 dark:bg-gray-800">
                <i class="fas fa-certificate text-4xl text-gray-400"></i>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400">{% trans "No certificates added yet" %}</p>
        </div>
        {% endif %}
    </div>

    <!-- Trainings without Certificates -->
    <div class="rounded-3xl border border-gray-200/70 bg-white p-6 shadow-sm dark:border-gray-700/60 dark:bg-gray-900/80">
        <div class="mb-6 flex items-center justify-between">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">
                <i class="fas fa-plus-circle mr-2 text-orange-500"></i>{% trans "Add Certificate Link" %}
            </h2>
            <span class="rounded-full bg-orange-100 px-3 py-1 text-sm font-semibold text-orange-700 dark:bg-orange-900/30 dark:text-orange-300">
                {{ without_certificates }} {% trans "pending" %}
            </span>
        </div>

        {% if trainings_without_certificates %}
        <div class="space-y-3">
            {% for training in trainings_without_certificates %}
            <div class="flex items-center justify-between rounded-xl border border-gray-200 bg-white p-4 dark:border-gray-700 dark:bg-gray-800">
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-900 dark:text-white">{{ training.resource.title }}</h4>
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                        <i class="fas fa-calendar-check mr-1"></i>{{ training.completed_date|date:"d.m.Y" }}
                        <span class="mx-2">â€¢</span>
                        <i class="fas fa-tag mr-1"></i>{{ training.resource.get_type_display }}
                    </p>
                </div>
                <button @click="addCertificate({{ training.id }})"
                        class="rounded-lg bg-gradient-to-r from-orange-500 to-red-500 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:shadow-md">
                    <i class="fas fa-plus mr-1"></i>{% trans "Add Certificate" %}
                </button>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="flex flex-col items-center justify-center gap-4 py-12 text-center">
            <div class="rounded-full bg-green-100 p-6 dark:bg-green-900/30">
                <i class="fas fa-check-circle text-4xl text-green-600 dark:text-green-400"></i>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400">{% trans "All completed trainings have certificates!" %}</p>
        </div>
        {% endif %}
    </div>

    <!-- Certificate Modal -->
    <div x-show="showModal"
         x-cloak
         @click.away="closeModal()"
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"
         style="display: none;">
        <div @click.stop
             class="w-full max-w-md rounded-2xl bg-white p-6 shadow-xl dark:bg-gray-800"
             x-transition>
            <div class="mb-4 flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                    <i class="fas fa-certificate mr-2 text-amber-500"></i>
                    <span x-text="modalTitle"></span>
                </h3>
                <button @click="closeModal()"
                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form @submit.prevent="saveCertificate()">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            {% trans "Certificate URL" %}
                        </label>
                        <input type="url"
                               x-model="certificateUrl"
                               required
                               placeholder="https://example.com/certificate.pdf"
                               class="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-amber-500 focus:ring-amber-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                    </div>

                    <div class="flex gap-3">
                        <button type="submit"
                                class="flex-1 rounded-lg bg-gradient-to-r from-amber-500 to-orange-500 px-4 py-2 font-semibold text-white shadow-sm transition hover:shadow-md">
                            <i class="fas fa-save mr-2"></i>{% trans "Save" %}
                        </button>
                        <button type="button"
                                @click="closeModal()"
                                class="flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2 font-semibold text-gray-700 transition hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                            {% trans "Cancel" %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function certificatesPage() {
    return {
        showModal: false,
        modalTitle: '',
        certificateUrl: '',
        currentTrainingId: null,
        isEdit: false,

        addCertificate(trainingId) {
            this.currentTrainingId = trainingId;
            this.certificateUrl = '';
            this.modalTitle = '{% trans "Add Certificate" %}';
            this.isEdit = false;
            this.showModal = true;
        },

        editCertificate(trainingId, currentUrl) {
            this.currentTrainingId = trainingId;
            this.certificateUrl = currentUrl;
            this.modalTitle = '{% trans "Edit Certificate" %}';
            this.isEdit = true;
            this.showModal = true;
        },

        closeModal() {
            this.showModal = false;
            this.certificateUrl = '';
            this.currentTrainingId = null;
        },

        async saveCertificate() {
            if (!this.certificateUrl || !this.currentTrainingId) {
                return;
            }

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                const response = await fetch(`/api/training/user-trainings/${this.currentTrainingId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({
                        certificate_url: this.certificateUrl
                    })
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('{% trans "Error saving certificate" %}');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('{% trans "Error saving certificate" %}');
            }
        }
    };
}

document.addEventListener('alpine:init', () => {
    Alpine.data('certificatesPage', certificatesPage);
});
</script>
{% endblock %}
