{% extends 'base/base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Competency Details" %} - Q360{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="mt-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">{% trans "Home" %}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'competencies:competency-list' %}">{% trans "Competencies" %}</a></li>
        <li class="breadcrumb-item active">{% trans "Details" %}</li>
    </ol>
</nav>
{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center mt-4 mb-3">
    <h1 class="h2"><i class="fas fa-lightbulb text-primary me-2"></i><span id="competencyName">{% trans "Competency Details" %}</span></h1>
    {% if user.is_admin %}
    <div>
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editCompetencyModal">
            <i class="fas fa-edit me-1"></i> {% trans "Edit" %}
        </button>
        <button class="btn btn-outline-danger" id="deleteBtn">
            <i class="fas fa-trash me-1"></i> {% trans "Delete" %}
        </button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Competency Information -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">{% trans "Competency Information" %}</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">{% trans "Name" %}:</dt>
                    <dd class="col-sm-9" id="detailName">-</dd>

                    <dt class="col-sm-3">{% trans "Description" %}:</dt>
                    <dd class="col-sm-9" id="detailDescription">-</dd>

                    <dt class="col-sm-3">{% trans "Status" %}:</dt>
                    <dd class="col-sm-9" id="detailStatus">-</dd>

                    <dt class="col-sm-3">{% trans "Created" %}:</dt>
                    <dd class="col-sm-9" id="detailCreated">-</dd>

                    <dt class="col-sm-3">{% trans "Last Updated" %}:</dt>
                    <dd class="col-sm-9" id="detailUpdated">-</dd>
                </dl>
            </div>
        </div>

        <!-- Positions Using This Competency -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">{% trans "Positions Requiring This Competency" %}</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>{% trans "Position" %}</th>
                                <th>{% trans "Department" %}</th>
                                <th>{% trans "Weight" %}</th>
                                <th>{% trans "Required Level" %}</th>
                            </tr>
                        </thead>
                        <tbody id="positionsTableBody">
                            <tr>
                                <td colspan="4" class="text-center">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">{% trans "Loading..." %}</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Users with This Skill -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">{% trans "Users with This Skill" %}</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>{% trans "User" %}</th>
                                <th>{% trans "Level" %}</th>
                                <th>{% trans "Score" %}</th>
                                <th>{% trans "Status" %}</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="4" class="text-center">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">{% trans "Loading..." %}</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Sidebar -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">{% trans "Statistics" %}</h5>
            </div>
            <div class="card-body">
                <div class="mb-3 text-center">
                    <h3 class="text-primary mb-0" id="statPositions">0</h3>
                    <p class="text-muted mb-0">{% trans "Positions" %}</p>
                </div>
                <hr>
                <div class="mb-3 text-center">
                    <h3 class="text-success mb-0" id="statUsers">0</h3>
                    <p class="text-muted mb-0">{% trans "Users with Skill" %}</p>
                </div>
                <hr>
                <div class="text-center">
                    <h3 class="text-info mb-0" id="statAvgScore">0</h3>
                    <p class="text-muted mb-0">{% trans "Average Score" %}</p>
                </div>
            </div>
        </div>

        <!-- Skill Level Distribution Chart -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">{% trans "Skill Level Distribution" %}</h5>
            </div>
            <div class="card-body">
                <canvas id="levelDistributionChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Edit Competency Modal -->
{% if user.is_admin %}
<div class="modal fade" id="editCompetencyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Edit Competency" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCompetencyForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">{% trans "Name" %} *</label>
                        <input type="text" class="form-control" name="name" id="editName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Description" %}</label>
                        <textarea class="form-control" name="description" id="editDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" id="editIsActive">
                            <label class="form-check-label" for="editIsActive">
                                {% trans "Active" %}
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "Save Changes" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
$(document).ready(function() {
    const competencyId = window.location.pathname.split('/').filter(x => x).pop();
    let chartInstance = null;

    // Load competency details
    function loadCompetencyDetails() {
        $.ajax({
            url: '/api/competencies/api/competencies/' + competencyId + '/',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            success: function(data) {
                // Update page title and details
                $('#competencyName').text(data.name);
                $('#detailName').text(data.name);
                $('#detailDescription').text(data.description || '{% trans "No description" %}');

                const statusBadge = data.is_active
                    ? '<span class="badge bg-success">{% trans "Active" %}</span>'
                    : '<span class="badge bg-secondary">{% trans "Inactive" %}</span>';
                $('#detailStatus').html(statusBadge);

                $('#detailCreated').text(new Date(data.created_at).toLocaleDateString());
                $('#detailUpdated').text(new Date(data.updated_at).toLocaleDateString());

                // Update edit form
                $('#editName').val(data.name);
                $('#editDescription').val(data.description);
                $('#editIsActive').prop('checked', data.is_active);

                // Update statistics
                $('#statPositions').text(data.active_positions_count || 0);
                $('#statUsers').text(data.total_users_with_skill || 0);
            },
            error: function(xhr) {
                console.error('Error loading competency:', xhr);
                alert('{% trans "Error loading competency details" %}');
            }
        });
    }

    // Load positions
    function loadPositions() {
        $.ajax({
            url: '/api/competencies/api/position-competencies/?competency=' + competencyId,
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            success: function(data) {
                let html = '';
                if (data.results && data.results.length === 0) {
                    html = '<tr><td colspan="4" class="text-center">{% trans "No positions found" %}</td></tr>';
                } else {
                    data.results.forEach(pc => {
                        html += `
                            <tr>
                                <td>${pc.position_name || '-'}</td>
                                <td>${pc.department_name || '-'}</td>
                                <td><span class="badge bg-info">${pc.weight}%</span></td>
                                <td>${pc.required_level_name || '-'}</td>
                            </tr>
                        `;
                    });
                }
                $('#positionsTableBody').html(html);
            },
            error: function(xhr) {
                $('#positionsTableBody').html(
                    '<tr><td colspan="4" class="text-center text-danger">{% trans "Error loading positions" %}</td></tr>'
                );
            }
        });
    }

    // Load users with this skill
    function loadUsers() {
        $.ajax({
            url: '/api/competencies/api/user-skills/?competency=' + competencyId,
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            },
            success: function(data) {
                let html = '';
                let totalScore = 0;
                let scoreCount = 0;
                const levelCounts = {};

                if (data.results && data.results.length === 0) {
                    html = '<tr><td colspan="4" class="text-center">{% trans "No users found" %}</td></tr>';
                } else {
                    data.results.forEach(skill => {
                        const statusBadge = skill.approval_status === 'approved'
                            ? 'bg-success'
                            : skill.approval_status === 'pending'
                            ? 'bg-warning'
                            : 'bg-danger';

                        html += `
                            <tr>
                                <td>${skill.user_full_name || '-'}</td>
                                <td>${skill.level_name || '-'}</td>
                                <td>${skill.current_score || '-'}</td>
                                <td><span class="badge ${statusBadge}">${skill.approval_status}</span></td>
                            </tr>
                        `;

                        if (skill.current_score) {
                            totalScore += parseFloat(skill.current_score);
                            scoreCount++;
                        }

                        // Count levels for chart
                        const levelName = skill.level_name || 'Unknown';
                        levelCounts[levelName] = (levelCounts[levelName] || 0) + 1;
                    });

                    // Update average score
                    const avgScore = scoreCount > 0 ? (totalScore / scoreCount).toFixed(1) : 0;
                    $('#statAvgScore').text(avgScore);

                    // Render chart
                    renderLevelDistributionChart(levelCounts);
                }
                $('#usersTableBody').html(html);
            },
            error: function(xhr) {
                $('#usersTableBody').html(
                    '<tr><td colspan="4" class="text-center text-danger">{% trans "Error loading users" %}</td></tr>'
                );
            }
        });
    }

    // Render level distribution chart
    function renderLevelDistributionChart(levelCounts) {
        const ctx = document.getElementById('levelDistributionChart');

        if (chartInstance) {
            chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(levelCounts),
                datasets: [{
                    data: Object.values(levelCounts),
                    backgroundColor: [
                        '#4e73df',
                        '#1cc88a',
                        '#36b9cc',
                        '#f6c23e',
                        '#e74a3b'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Handle edit form submission
    $('#editCompetencyForm').submit(function(e) {
        e.preventDefault();

        const formData = {
            name: $('#editName').val(),
            description: $('#editDescription').val(),
            is_active: $('#editIsActive').is(':checked')
        };

        $.ajax({
            url: '/api/competencies/api/competencies/' + competencyId + '/',
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(formData),
            success: function() {
                $('#editCompetencyModal').modal('hide');
                loadCompetencyDetails();
                alert('{% trans "Competency updated successfully" %}');
            },
            error: function(xhr) {
                alert('{% trans "Error updating competency" %}');
            }
        });
    });

    // Handle delete button
    $('#deleteBtn').click(function() {
        if (confirm('{% trans "Are you sure you want to delete this competency?" %}')) {
            $.ajax({
                url: '/api/competencies/api/competencies/' + competencyId + '/',
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                },
                success: function() {
                    alert('{% trans "Competency deleted successfully" %}');
                    window.location.href = '{% url "competencies:competency-list" %}';
                },
                error: function(xhr) {
                    alert('{% trans "Error deleting competency" %}');
                }
            });
        }
    });

    // Initial load
    loadCompetencyDetails();
    loadPositions();
    loadUsers();
});
</script>
{% endblock %}
