{% extends "base/base.html" %}
{% load static %}

{% block title %}Bildiriş Şablonları - Q360{% endblock %}

{% block extra_css %}
<style>
    .template-card {
        transition: all 0.3s;
        border-left: 4px solid #0d6efd;
    }
    .template-card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transform: translateY(-3px);
    }
    .variable-chip {
        background: #e7f3ff;
        border: 1px solid #0d6efd;
        color: #0d6efd;
        padding: 2px 8px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.85rem;
    }
    .template-preview {
        background: #f8f9fa;
        border: 1px dashed #dee2e6;
        padding: 15px;
        border-radius: 8px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="mt-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Əsas Səhifə</a></li>
        <li class="breadcrumb-item"><a href="{% url 'notifications:inbox' %}">Bildirişlər</a></li>
        <li class="breadcrumb-item active" aria-current="page">Şablonlar</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="fas fa-file-alt"></i> Bildiriş Şablonları
            </h1>
            <p class="text-muted mb-0">
                Sistem bildirişləri üçün şablon idarəetməsi
            </p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTemplateModal">
            <i class="fas fa-plus"></i> Yeni Şablon
        </button>
    </div>

    <!-- Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0 text-center">
                <div class="card-body">
                    <i class="fas fa-file-alt text-primary mb-2" style="font-size: 30px;"></i>
                    <h3 class="mb-0 text-primary">{{ total_templates|default:0 }}</h3>
                    <small class="text-muted">Ümumi Şablon</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 text-center">
                <div class="card-body">
                    <i class="fas fa-check-circle text-success mb-2" style="font-size: 30px;"></i>
                    <h3 class="mb-0 text-success">{{ active_templates|default:0 }}</h3>
                    <small class="text-muted">Aktiv</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 text-center">
                <div class="card-body">
                    <i class="fas fa-paper-plane text-info mb-2" style="font-size: 30px;"></i>
                    <h3 class="mb-0 text-info">{{ sent_count|default:0 }}</h3>
                    <small class="text-muted">Göndərilmiş</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 text-center">
                <div class="card-body">
                    <i class="fas fa-language text-warning mb-2" style="font-size: 30px;"></i>
                    <h3 class="mb-0 text-warning">2</h3>
                    <small class="text-muted">Dil Dəstəyi</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Categories -->
    <div class="row">
        <!-- Evaluation Templates -->
        <div class="col-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-check"></i> Qiymətləndirmə Bildirişləri
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for template in evaluation_templates %}
                        <div class="col-md-6 mb-3">
                            <div class="template-card card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="mb-0">{{ template.name }}</h6>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox"
                                                   {% if template.is_active %}checked{% endif %}
                                                   data-template-id="{{ template.id }}">
                                        </div>
                                    </div>
                                    <p class="text-muted small mb-2">{{ template.description }}</p>
                                    <div class="template-preview mb-3">
                                        <strong>{{ template.subject }}</strong>
                                        <p class="mb-0 mt-2 text-muted small">
                                            {{ template.body|truncatewords:20 }}
                                        </p>
                                    </div>
                                    <div class="mb-3">
                                        <small class="text-muted d-block mb-1">Mövcud dəyişənlər:</small>
                                        <div class="d-flex gap-1 flex-wrap">
                                            {% for var in template.variables %}
                                            <span class="variable-chip">{{ var }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-primary flex-fill"
                                                onclick="editTemplate({{ template.id }})">
                                            <i class="fas fa-edit"></i> Redaktə
                                        </button>
                                        <button class="btn btn-sm btn-outline-info"
                                                onclick="previewTemplate({{ template.id }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger"
                                                onclick="deleteTemplate({{ template.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>Şablon tapılmadı</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Deadline Templates -->
        <div class="col-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-clock"></i> Deadline Xatırlatmaları
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for template in deadline_templates %}
                        <div class="col-md-6 mb-3">
                            <div class="template-card card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="mb-0">{{ template.name }}</h6>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox"
                                                   {% if template.is_active %}checked{% endif %}
                                                   data-template-id="{{ template.id }}">
                                        </div>
                                    </div>
                                    <p class="text-muted small mb-2">{{ template.description }}</p>
                                    <div class="template-preview mb-3">
                                        <strong>{{ template.subject }}</strong>
                                        <p class="mb-0 mt-2 text-muted small">
                                            {{ template.body|truncatewords:20 }}
                                        </p>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-primary flex-fill"
                                                onclick="editTemplate({{ template.id }})">
                                            <i class="fas fa-edit"></i> Redaktə
                                        </button>
                                        <button class="btn btn-sm btn-outline-info"
                                                onclick="previewTemplate({{ template.id }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger"
                                                onclick="deleteTemplate({{ template.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>Şablon tapılmadı</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- System Templates -->
        <div class="col-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cog"></i> Sistem Bildirişləri
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for template in system_templates %}
                        <div class="col-md-6 mb-3">
                            <div class="template-card card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="mb-0">{{ template.name }}</h6>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox"
                                                   {% if template.is_active %}checked{% endif %}
                                                   data-template-id="{{ template.id }}">
                                        </div>
                                    </div>
                                    <p class="text-muted small mb-2">{{ template.description }}</p>
                                    <div class="template-preview mb-3">
                                        <strong>{{ template.subject }}</strong>
                                        <p class="mb-0 mt-2 text-muted small">
                                            {{ template.body|truncatewords:20 }}
                                        </p>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-primary flex-fill"
                                                onclick="editTemplate({{ template.id }})">
                                            <i class="fas fa-edit"></i> Redaktə
                                        </button>
                                        <button class="btn btn-sm btn-outline-info"
                                                onclick="previewTemplate({{ template.id }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger"
                                                onclick="deleteTemplate({{ template.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>Şablon tapılmadı</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Template Modal -->
<div class="modal fade" id="createTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> Yeni Bildiriş Şablonu
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createTemplateForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Şablon Adı</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kateqoriya</label>
                        <select class="form-select" name="category" required>
                            <option value="evaluation">Qiymətləndirmə</option>
                            <option value="deadline">Deadline</option>
                            <option value="report">Hesabat</option>
                            <option value="system">Sistem</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Açıqlama</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mövzu</label>
                        <input type="text" class="form-control" name="subject" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Məzmun</label>
                        <textarea class="form-control" name="body" rows="6" required></textarea>
                        <small class="text-muted">
                            Dəyişənlər: {user_name}, {campaign_name}, {deadline}, {url}
                        </small>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" checked>
                            <label class="form-check-label">Aktiv</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ləğv et</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()">
                    <i class="fas fa-save"></i> Saxla
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function saveTemplate() {
    const form = document.getElementById('createTemplateForm');
    const formData = new FormData(form);

    fetch('/notifications/templates/create/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    })
    .catch(error => console.error('Error:', error));
}

function editTemplate(templateId) {
    window.location.href = `/notifications/templates/${templateId}/edit/`;
}

function previewTemplate(templateId) {
    window.open(`/notifications/templates/${templateId}/preview/`, '_blank', 'width=600,height=800');
}

function deleteTemplate(templateId) {
    if (confirm('Bu şablonu silmək istədiyinizə əminsiniz?')) {
        fetch(`/notifications/templates/${templateId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

// Toggle template active status
document.querySelectorAll('.form-check-input[data-template-id]').forEach(toggle => {
    toggle.addEventListener('change', function() {
        const templateId = this.dataset.templateId;
        const isActive = this.checked;

        fetch(`/notifications/templates/${templateId}/toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_active: isActive })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                this.checked = !isActive;
            }
        })
        .catch(error => console.error('Error:', error));
    });
});
</script>
{% endblock %}
