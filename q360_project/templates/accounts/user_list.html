{% extends 'base/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Users" %} - Q360{% endblock %}

{% block page_header %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
            {% trans "Users" %}
        </h1>
        <p class="text-gray-600 dark:text-gray-400 mt-1">{% trans "Manage system users" %}</p>
    </div>
    <div class="flex gap-2">
        <button onclick="window.location.reload()" class="flex items-center px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <i class="fas fa-sync mr-2"></i>
            {% trans "Refresh" %}
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Users -->
    <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 rounded-xl p-6 border border-blue-200 dark:border-blue-700 shadow-sm hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-blue-600 dark:text-blue-400 uppercase tracking-wide">{% trans "Total Users" %}</p>
                <p class="text-3xl font-bold text-blue-700 dark:text-blue-300 mt-2">{{ total_users|default:0 }}</p>
            </div>
            <div class="bg-blue-500 bg-opacity-20 p-3 rounded-lg">
                <i class="fas fa-users text-2xl text-blue-600 dark:text-blue-400"></i>
            </div>
        </div>
    </div>
</div>

<!-- User List with AJAX Pagination -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700" x-data="userListPagination()">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
            <i class="fas fa-list mr-2 text-blue-600"></i>
            {% trans "User List" %}
            <span x-show="totalUsers > 0" class="text-sm font-normal text-gray-500 dark:text-gray-400">
                (<span x-text="displayedUsers"></span> {% trans "of" %} <span x-text="totalUsers"></span>)
            </span>
        </h2>
    </div>
    <div class="p-6">
        <!-- Initial Server-Side Rendered Content -->
        <div class="overflow-x-auto" x-show="!ajaxMode || users.length === 0">
            <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "User" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Email" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Department" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Role" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Status" %}</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700" id="userTableBody">
                    {% if users %}
                        {% for user_item in users %}
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <td class="px-4 py-4">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-semibold text-sm">
                                        {{ user_item.first_name.0|default:user_item.username.0|upper }}
                                    </div>
                                    <div class="ml-3">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">{{ user_item.get_full_name|default:user_item.username }}</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">@{{ user_item.username }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-4 text-sm text-gray-600 dark:text-gray-300">{{ user_item.email|default:"N/A" }}</td>
                            <td class="px-4 py-4 text-sm text-gray-600 dark:text-gray-300">{{ user_item.department|default:"N/A" }}</td>
                            <td class="px-4 py-4">
                                <span class="px-2 py-1 text-xs font-medium rounded-full {% if user_item.is_superuser %}bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300{% else %}bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300{% endif %}">
                                    {{ user_item.get_role_display|default:"User" }}
                                </span>
                            </td>
                            <td class="px-4 py-4">
                                <span class="px-2 py-1 text-xs font-medium rounded-full {% if user_item.is_active %}bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300{% else %}bg-gray-100 dark:bg-gray-900/30 text-gray-800 dark:text-gray-300{% endif %}">
                                    {% if user_item.is_active %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="px-4 py-12 text-center">
                                <i class="fas fa-users text-6xl text-gray-300 dark:text-gray-600 mb-4 block"></i>
                                <p class="text-gray-500 dark:text-gray-400">{% trans "No users found" %}</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- AJAX-Rendered Content -->
        <div class="overflow-x-auto" x-show="ajaxMode && users.length > 0">
            <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "User" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Email" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Department" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Role" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Status" %}</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    <template x-for="user in users" :key="user.id">
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <td class="px-4 py-4">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-semibold text-sm" x-text="userInitial(user)"></div>
                                    <div class="ml-3">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white" x-text="userFullName(user)"></div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400" x-text="'@' + user.username"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-4 text-sm text-gray-600 dark:text-gray-300" x-text="user.email || 'N/A'"></td>
                            <td class="px-4 py-4 text-sm text-gray-600 dark:text-gray-300" x-text="user.department_name || 'N/A'"></td>
                            <td class="px-4 py-4">
                                <span class="px-2 py-1 text-xs font-medium rounded-full" :class="user.is_superuser ? 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300' : 'bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300'" x-text="user.role_display || 'User'"></span>
                            </td>
                            <td class="px-4 py-4">
                                <span class="px-2 py-1 text-xs font-medium rounded-full" :class="user.is_active ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300' : 'bg-gray-100 dark:bg-gray-900/30 text-gray-800 dark:text-gray-300'" x-text="user.is_active ? '{% trans "Active" %}' : '{% trans "Inactive" %}'"></span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Loading Skeleton -->
        <div x-show="loading" class="space-y-4 animate-pulse">
            <template x-for="i in 5" :key="i">
                <div class="flex items-center gap-4 p-4">
                    <div class="w-10 h-10 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
                    <div class="flex-1 space-y-2">
                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/4"></div>
                        <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/3"></div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Load More Button -->
        <div class="mt-6 text-center" x-show="hasMore && !loading">
            <button @click="loadMore" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white rounded-lg font-semibold shadow-md hover:shadow-lg transition-all duration-200">
                <i class="fas fa-chevron-down mr-2"></i>
                {% trans "Load More" %}
            </button>
        </div>

        <!-- End Message -->
        <div class="mt-6 text-center text-gray-500 dark:text-gray-400 text-sm" x-show="!hasMore && users.length > 0">
            <i class="fas fa-check-circle mr-2"></i>
            {% trans "All users loaded" %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function userListPagination() {
    return {
        users: [],
        ajaxMode: false,
        loading: false,
        page: 1,
        pageSize: 20,
        totalUsers: {{ total_users|default:0 }},
        hasMore: true,

        get displayedUsers() {
            return this.ajaxMode ? this.users.length : {{ users|length|default:0 }};
        },

        userInitial(user) {
            if (user.first_name) {
                return user.first_name.charAt(0).toUpperCase();
            } else if (user.username) {
                return user.username.charAt(0).toUpperCase();
            }
            return '?';
        },

        userFullName(user) {
            if (user.first_name && user.last_name) {
                return user.first_name + ' ' + user.last_name;
            } else if (user.username) {
                return user.username;
            }
            return 'N/A';
        },

        async loadMore() {
            // On first click, fetch from beginning
            if (!this.ajaxMode) {
                this.ajaxMode = true;
                this.page = 1;
                this.users = [];
            } else {
                this.page++;
            }

            this.loading = true;

            try {
                const url = `/api/accounts/users/?page=${this.page}&page_size=${this.pageSize}`;
                const response = await fetch(url, {
                    headers: {
                        'Accept': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load users');
                }

                const data = await response.json();

                // Handle both DRF pagination formats
                const results = data.results || data;

                if (results && results.length > 0) {
                    this.users = [...this.users, ...results];

                    // Check if there are more pages
                    if (data.next) {
                        this.hasMore = true;
                    } else {
                        // Alternative: check if we received less than page size
                        this.hasMore = results.length === this.pageSize;
                    }
                } else {
                    this.hasMore = false;
                }

                // Update total count if provided
                if (data.count !== undefined) {
                    this.totalUsers = data.count;
                }
            } catch (error) {
                console.error('Error loading users:', error);
                this.showToast('{% trans "Failed to load users" %}', 'error');
                this.hasMore = false;
            } finally {
                this.loading = false;
            }
        },

        showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white ${
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }
    };
}

document.addEventListener('alpine:init', () => {
    Alpine.data('userListPagination', userListPagination);
});
</script>
{% endblock %}
