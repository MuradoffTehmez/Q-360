{% extends "base/base.html" %}
{% load static %}

{% block title %}Tənzimləmələr - Q360{% endblock %}

{% block extra_css %}
<style>
    .settings-nav {
        position: sticky;
        top: 80px;
    }
    .settings-nav .nav-link {
        color: #6c757d;
        padding: 12px 20px;
        border-left: 3px solid transparent;
        transition: all 0.3s;
    }
    .settings-nav .nav-link:hover {
        background: #f8f9fa;
        color: #0d6efd;
    }
    .settings-nav .nav-link.active {
        color: #0d6efd;
        background: #e7f3ff;
        border-left-color: #0d6efd;
        font-weight: 500;
    }
    .settings-section {
        scroll-margin-top: 100px;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb" class="mt-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Əsas Səhifə</a></li>
        <li class="breadcrumb-item"><a href="{% url 'accounts:profile' %}">Profil</a></li>
        <li class="breadcrumb-item active" aria-current="page">Tənzimləmələr</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-1">
                <i class="fas fa-cog"></i> Tənzimləmələr
            </h1>
            <p class="text-muted mb-0">Hesab və bildiriş tənzimləmələrinizi idarə edin</p>
        </div>
    </div>

    <div class="row">
        <!-- Settings Navigation -->
        <div class="col-lg-3 mb-4">
            <div class="card shadow-sm settings-nav">
                <div class="card-body p-0">
                    <nav class="nav flex-column">
                        <a class="nav-link active" href="#general">
                            <i class="fas fa-sliders-h me-2"></i>Ümumi
                        </a>
                        <a class="nav-link" href="#notifications">
                            <i class="fas fa-bell me-2"></i>Bildirişlər
                        </a>
                        <a class="nav-link" href="#privacy">
                            <i class="fas fa-lock me-2"></i>Məxfilik
                        </a>
                        <a class="nav-link" href="#appearance">
                            <i class="fas fa-palette me-2"></i>Görünüş
                        </a>
                        <a class="nav-link" href="#language">
                            <i class="fas fa-language me-2"></i>Dil
                        </a>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Settings Content -->
        <div class="col-lg-9">
            <form method="post" id="settingsForm">
                {% csrf_token %}

                <!-- General Settings -->
                <div class="card shadow-sm mb-4 settings-section" id="general">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-sliders-h"></i> Ümumi Tənzimləmələr
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-clock me-2"></i>Vaxt Zonası
                            </label>
                            <select class="form-select" name="timezone">
                                <option value="Asia/Baku" selected>Azərbaycan (GMT+4)</option>
                                <option value="Europe/Moscow">Moskva (GMT+3)</option>
                                <option value="Europe/Istanbul">İstanbul (GMT+3)</option>
                            </select>
                            <small class="text-muted">Tariх və saatlar bu vaxt zonasında göstəriləcək</small>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-calendar me-2"></i>Tarix Formatı
                            </label>
                            <select class="form-select" name="date_format">
                                <option value="DD.MM.YYYY" selected>31.12.2024</option>
                                <option value="MM/DD/YYYY">12/31/2024</option>
                                <option value="YYYY-MM-DD">2024-12-31</option>
                            </select>
                        </div>

                        <div class="mb-0">
                            <label class="form-label fw-bold">
                                <i class="fas fa-list me-2"></i>Səhifə Başına Element Sayı
                            </label>
                            <select class="form-select" name="items_per_page">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <small class="text-muted">Siyahılarda göstəriləcək element sayı</small>
                        </div>
                    </div>
                </div>

                <!-- Notification Settings -->
                <div class="card shadow-sm mb-4 settings-section" id="notifications">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-bell"></i> Bildiriş Tənzimləmələri
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h6 class="mb-3">Email Bildirişləri</h6>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailEvaluations" name="email_evaluations" checked>
                                <label class="form-check-label" for="emailEvaluations">
                                    <strong>Yeni qiymətləndirmə tapşırıqları</strong>
                                    <small class="d-block text-muted">Sizə yeni qiymətləndirmə təyin edildikdə email göndər</small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailDeadlines" name="email_deadlines" checked>
                                <label class="form-check-label" for="emailDeadlines">
                                    <strong>Deadline xatırlatmaları</strong>
                                    <small class="d-block text-muted">Son tarix yaxınlaşdıqda xatırlatma göndər</small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailReports" name="email_reports" checked>
                                <label class="form-check-label" for="emailReports">
                                    <strong>Hesabat hazır olduqda</strong>
                                    <small class="d-block text-muted">Qiymətləndirmə hesabatınız hazır olduqda bildiriş göndər</small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailWeekly" name="email_weekly">
                                <label class="form-check-label" for="emailWeekly">
                                    <strong>Həftəlik xülasə</strong>
                                    <small class="d-block text-muted">Hər həftə fəaliyyət xülasəsi göndər</small>
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h6 class="mb-3">Sistem Bildirişləri</h6>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="pushNotifications" name="push_notifications" checked>
                                <label class="form-check-label" for="pushNotifications">
                                    <strong>Push bildirişlər</strong>
                                    <small class="d-block text-muted">Brauzer bildirişlərini aktivləşdir</small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="soundNotifications" name="sound_notifications">
                                <label class="form-check-label" for="soundNotifications">
                                    <strong>Səs bildirişləri</strong>
                                    <small class="d-block text-muted">Yeni bildiriş gəldikdə səs çal</small>
                                </label>
                            </div>
                        </div>

                        <div class="mb-0">
                            <h6 class="mb-3">Bildiriş Tezliyi</h6>
                            <select class="form-select" name="notification_frequency">
                                <option value="instant" selected>Dərhal</option>
                                <option value="hourly">Saatlıq</option>
                                <option value="daily">Gündəlik</option>
                                <option value="weekly">Həftəlik</option>
                            </select>
                            <small class="text-muted">Email bildirişlərinin nə vaxt göndəriləcəyini seçin</small>
                        </div>
                    </div>
                </div>

                <!-- Privacy Settings -->
                <div class="card shadow-sm mb-4 settings-section" id="privacy">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-lock"></i> Məxfilik Tənzimləmələri
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h6 class="mb-3">Profil Görünürlüyü</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="profile_visibility" id="visibilityPublic" value="public" checked>
                                <label class="form-check-label" for="visibilityPublic">
                                    <strong>Hamı</strong>
                                    <small class="d-block text-muted">Bütün istifadəçilər profilinizi görə bilər</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="profile_visibility" id="visibilityTeam" value="team">
                                <label class="form-check-label" for="visibilityTeam">
                                    <strong>Yalnız komanda</strong>
                                    <small class="d-block text-muted">Yalnız eyni departamentdəkilər görə bilər</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="profile_visibility" id="visibilityPrivate" value="private">
                                <label class="form-check-label" for="visibilityPrivate">
                                    <strong>Məxfi</strong>
                                    <small class="d-block text-muted">Yalnız rəhbər və HR görə bilər</small>
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h6 class="mb-3">Məlumat Paylaşımı</h6>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="shareResults" name="share_results" checked>
                                <label class="form-check-label" for="shareResults">
                                    <strong>Nəticələri paylaş</strong>
                                    <small class="d-block text-muted">Qiymətləndirmə nəticələrimi rəhbərlə paylaş</small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="shareActivity" name="share_activity" checked>
                                <label class="form-check-label" for="shareActivity">
                                    <strong>Fəaliyyəti göstər</strong>
                                    <small class="d-block text-muted">Son fəaliyyətlərimi komandaya göstər</small>
                                </label>
                            </div>
                        </div>

                        <div class="mb-0">
                            <h6 class="mb-3">Məlumat İdarəetməsi</h6>
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-primary" onclick="exportData()">
                                    <i class="fas fa-download me-2"></i>Məlumatlarımı İxrac Et
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="requestDataDeletion()">
                                    <i class="fas fa-trash me-2"></i>Məlumatlarımın Silinməsini Tələb Et
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Appearance Settings -->
                <div class="card shadow-sm mb-4 settings-section" id="appearance">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-palette"></i> Görünüş Tənzimləmələri
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-moon me-2"></i>Tema
                            </label>
                            <select class="form-select" name="theme">
                                <option value="light" selected>İşıqlı</option>
                                <option value="dark">Qaranlıq</option>
                                <option value="auto">Avtomatik (Sistem ayarına görə)</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-text-height me-2"></i>Şrift Ölçüsü
                            </label>
                            <select class="form-select" name="font_size">
                                <option value="small">Kiçik</option>
                                <option value="medium" selected>Orta</option>
                                <option value="large">Böyük</option>
                            </select>
                        </div>

                        <div class="mb-0">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="compactMode" name="compact_mode">
                                <label class="form-check-label" for="compactMode">
                                    <strong>Sıx görünüş rejimi</strong>
                                    <small class="d-block text-muted">Daha çox məlumat görmək üçün elementləri sıxlaşdır</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Language Settings -->
                <div class="card shadow-sm mb-4 settings-section" id="language">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-language"></i> Dil Tənzimləmələri
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label fw-bold">İnterfeys Dili</label>
                            <select class="form-select" name="language">
                                <option value="az" selected>Azərbaycan dili</option>
                                <option value="en">English</option>
                                <option value="ru">Русский</option>
                            </select>
                        </div>

                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Qeyd:</strong> Dil dəyişdirildikdən sonra səhifə yenidən yüklənəcək
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="card shadow-sm sticky-bottom bg-white border-top">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Dəyişikliklər avtomatik olaraq saxlanılır
                            </small>
                            <div>
                                <button type="button" class="btn btn-outline-secondary me-2" onclick="resetSettings()">
                                    <i class="fas fa-undo"></i> Sıfırla
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Dəyişiklikləri Saxla
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Smooth scroll for settings navigation
    document.querySelectorAll('.settings-nav a').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();

            // Remove active class from all links
            document.querySelectorAll('.settings-nav a').forEach(l => l.classList.remove('active'));
            this.classList.add('active');

            // Scroll to section
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });

    // Auto-save on change
    const form = document.getElementById('settingsForm');
    const inputs = form.querySelectorAll('input, select');

    inputs.forEach(input => {
        input.addEventListener('change', function() {
            autoSave();
        });
    });

    function autoSave() {
        const formData = new FormData(form);

        fetch(form.action || window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Tənzimləmələr saxlanıldı', 'success');
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch(this.action || window.location.href, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Tənzimləmələr uğurla saxlanıldı', 'success');
            }
        })
        .catch(error => console.error('Error:', error));
    });
});

function resetSettings() {
    if (confirm('Bütün tənzimləmələri ilkin vəziyyətə qaytarmaq istədiyinizə əminsiniz?')) {
        fetch('/accounts/settings/reset/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
}

function exportData() {
    window.location.href = '/accounts/export-data/';
    showToast('Məlumatlarınız hazırlanır və email ünvanınıza göndəriləcək', 'info');
}

function requestDataDeletion() {
    if (confirm('Məlumatlarınızın silinməsini tələb etmək istədiyinizə əminsiniz? Bu əməliyyat geri alına bilməz.')) {
        fetch('/accounts/request-deletion/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Silinmə tələbi qeydə alındı. 30 gün ərzində məlumatlarınız silinəcək.', 'warning');
            }
        });
    }
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'info' ? 'info' : type === 'warning' ? 'warning' : 'danger'} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = message;
    document.body.appendChild(toast);

    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}
