{% extends 'base/base.html' %}
{% load i18n %}
{% load static %}
{% load wellness_tags %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h3 mb-1">
                <i class="fas fa-heartbeat text-danger me-2"></i>
                {% trans "Sağlamlıq və Wellness Dashboard" %}
            </h2>
            <p class="text-muted mb-0">{% trans "Sağlamlığınızı izləyin və aktiv qalın" %}</p>
        </div>
        <div>
            <a href="{% url 'wellness:mental_health_survey' %}" class="btn btn-primary">
                <i class="fas fa-clipboard-check me-2"></i>
                {% trans "Mental Sağlamlıq Survey" %}
            </a>
        </div>
    </div>

    <!-- Health Score Card -->
    {% if latest_health_score %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3 text-center">
                            <div class="position-relative d-inline-block">
                                <svg width="150" height="150" viewBox="0 0 150 150">
                                    <circle cx="75" cy="75" r="65" fill="none" stroke="#e9ecef" stroke-width="12"/>
                                    <circle cx="75" cy="75" r="65" fill="none"
                                            stroke="{% if latest_health_score.overall_score >= 80 %}#28a745{% elif latest_health_score.overall_score >= 60 %}#ffc107{% else %}#dc3545{% endif %}"
                                            stroke-width="12" stroke-dasharray="{{ latest_health_score.overall_score }},100"
                                            transform="rotate(-90 75 75)" stroke-linecap="round"/>
                                </svg>
                                <div class="position-absolute top-50 start-50 translate-middle text-center">
                                    <h2 class="mb-0 fw-bold">{{ latest_health_score.overall_score }}</h2>
                                    <small class="text-muted">{% trans "Skor" %}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <h5 class="mb-3">{% trans "Sağlamlıq Skorunuz" %}</h5>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-running text-primary fa-2x me-3"></i>
                                        <div>
                                            <small class="text-muted d-block">{% trans "Fiziki Sağlamlıq" %}</small>
                                            <strong>{{ latest_health_score.physical_health }}/100</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-brain text-info fa-2x me-3"></i>
                                        <div>
                                            <small class="text-muted d-block">{% trans "Mental Sağlamlıq" %}</small>
                                            <strong>{{ latest_health_score.mental_health }}/100</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-fire text-danger fa-2x me-3"></i>
                                        <div>
                                            <small class="text-muted d-block">{% trans "Aktivlik" %}</small>
                                            <strong>{{ latest_health_score.activity_level }}/100</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <a href="{% url 'wellness:health_score_history' %}" class="btn btn-sm btn-outline-primary">
                                    {% trans "Tarixçə" %} <i class="fas fa-arrow-right ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Stats -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-primary bg-opacity-10 rounded p-3">
                                <i class="fas fa-walking fa-2x text-primary"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <small class="text-muted d-block">{% trans "Ortalama Addım" %}</small>
                            <h4 class="mb-0">{{ avg_daily_steps|floatformat:0 }}</h4>
                        </div>
                    </div>
                    <a href="{% url 'wellness:step_tracking' %}" class="btn btn-sm btn-link mt-2 p-0">{% trans "Detallı bax" %} →</a>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-success bg-opacity-10 rounded p-3">
                                <i class="fas fa-dumbbell fa-2x text-success"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <small class="text-muted d-block">{% trans "Aktiv Proqramlar" %}</small>
                            <h4 class="mb-0">{{ active_fitness_programs.count }}</h4>
                        </div>
                    </div>
                    <a href="{% url 'wellness:fitness_programs' %}" class="btn btn-sm btn-link mt-2 p-0">{% trans "Proqramlara bax" %} →</a>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-warning bg-opacity-10 rounded p-3">
                                <i class="fas fa-trophy fa-2x text-warning"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <small class="text-muted d-block">{% trans "Aktiv Yarışlar" %}</small>
                            <h4 class="mb-0">{{ active_challenges.count }}</h4>
                        </div>
                    </div>
                    <a href="{% url 'wellness:challenges' %}" class="btn btn-sm btn-link mt-2 p-0">{% trans "Yarışlara bax" %} →</a>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-info bg-opacity-10 rounded p-3">
                                <i class="fas fa-file-medical fa-2x text-info"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <small class="text-muted d-block">{% trans "Gözləyən Tələblər" %}</small>
                            <h4 class="mb-0">{{ pending_claims }}</h4>
                        </div>
                    </div>
                    <a href="{% url 'wellness:medical_claims' %}" class="btn btn-sm btn-link mt-2 p-0">{% trans "Tələblərə bax" %} →</a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Upcoming Checkups -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-check text-primary me-2"></i>
                        {% trans "Gələcək Müayinələr" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if upcoming_checkups %}
                        <div class="list-group list-group-flush">
                            {% for checkup in upcoming_checkups %}
                            <div class="list-group-item border-0 px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ checkup.get_checkup_type_display }}</h6>
                                        <small class="text-muted">
                                            <i class="fas fa-calendar me-1"></i>
                                            {{ checkup.scheduled_date|date:"d M Y, H:i" }}
                                        </small>
                                        {% if checkup.provider %}
                                        <br><small class="text-muted">
                                            <i class="fas fa-hospital me-1"></i>
                                            {{ checkup.provider }}
                                        </small>
                                        {% endif %}
                                    </div>
                                    <a href="{% url 'wellness:checkup_detail' checkup.id %}" class="btn btn-sm btn-outline-primary">
                                        {% trans "Detallar" %}
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <p class="text-muted">{% trans "Planlaşdırılmış müayinə yoxdur" %}</p>
                            <a href="{% url 'wellness:checkup_create' %}" class="btn btn-sm btn-primary">
                                {% trans "Müayinə planlaşdır" %}
                            </a>
                        </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-white border-0">
                    <a href="{% url 'wellness:checkup_list' %}" class="btn btn-sm btn-link">
                        {% trans "Bütün müayinələr" %} <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Recent Steps -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-shoe-prints text-success me-2"></i>
                        {% trans "Son 7 Gün - Addımlar" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_steps %}
                        <canvas id="stepsChart" height="200"></canvas>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                            <p class="text-muted">{% trans "Addım məlumatı yoxdur" %}</p>
                        </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-white border-0">
                    <a href="{% url 'wellness:step_tracking' %}" class="btn btn-sm btn-link">
                        {% trans "Ətraflı statistika" %} <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Mental Health Status -->
    {% if latest_survey %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-brain text-info me-2"></i>
                        {% trans "Son Mental Sağlamlıq Survey" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center mb-3 mb-md-0">
                            <div class="h2 mb-1">
                                {% if latest_survey.stress_level <= 2 %}
                                    <i class="fas fa-smile text-success"></i>
                                {% elif latest_survey.stress_level <= 3 %}
                                    <i class="fas fa-meh text-warning"></i>
                                {% else %}
                                    <i class="fas fa-frown text-danger"></i>
                                {% endif %}
                            </div>
                            <p class="mb-0 text-muted small">{{ latest_survey.survey_date|date:"d M Y" }}</p>
                        </div>
                        <div class="col-md-9">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <small class="text-muted d-block">{% trans "Stress Səviyyəsi" %}</small>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar {% if latest_survey.stress_level >= 4 %}bg-danger{% elif latest_survey.stress_level >= 3 %}bg-warning{% else %}bg-success{% endif %}"
                                             style="width: {{ latest_survey.stress_level|multiply:20 }}%"></div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted d-block">{% trans "İş-Həyat Balansı" %}</small>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-info" style="width: {{ latest_survey.work_life_balance|multiply:20 }}%"></div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted d-block">{% trans "Yuxu Keyfiyyəti" %}</small>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-primary" style="width: {{ latest_survey.sleep_quality|multiply:20 }}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if recent_steps %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var ctx = document.getElementById('stepsChart').getContext('2d');
    var stepsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [{% for step in recent_steps reversed %}'{{ step.tracking_date|date:"d M" }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '{% trans "Addımlar" %}',
                data: [{% for step in recent_steps reversed %}{{ step.steps }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
});
</script>
{% endif %}
{% endblock %}
